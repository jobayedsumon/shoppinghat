"use strict";!function(e){function t(t){return!!e(t).sbLoading()||(e(t).sbLoading(!0),!1)}function i(e,t=E){return N.storage(e,t)}function s(e){return N.translate(e)}function a(e=-1){if(-1===e)return window.sb_current_user;window.sb_current_user=e}function n(){(o=e(".sb-admin, .sb-chat, .sb-tickets")).length&&typeof SB_AJAX_URL!=E?(d=o.find(".sb-list"),u=o.find(".sb-editor"),h=u.find("textarea"),m=o.find(_||y?".sb-list":"> div > .sb-scroll-area"),g=m.find(".sb-header"),f=u.find(".sb-emoji"),p=y?o.find(".sb-profile-agent .sb-status"):null,q.enabledAutoExpand(),q.audio=o.find("#sb-audio").get(0),q.audio_out=o.find("#sb-audio-out").get(0),N.cookie("sb-check","ok",1,"set"),"ok"!=N.cookie("sb-check")?(j=!1,console.warn("Support Board: cookies not available.")):N.cookie("sb-check",!1,!1,!1),_?N.event("SBReady"):(N.ajax({function:"get-front-settings",current_url:window.location.href},e=>{v=(C=e)["bot-id"],b=C["dialogflow-human-takeover"],x=C["agents-online"],L.active=C.pusher,typeof SB_REGISTRATION_REQUIRED!=E&&(C["registration-required"]=SB_REGISTRATION_REQUIRED,C["tickets-registration-required"]=SB_REGISTRATION_REQUIRED),typeof SB_ARTICLES_PAGE!=E&&SB_ARTICLES_PAGE&&q.initArticlesPage(),y&&C["tickets-manual-init"]||(!y||C["tickets-manual-init"])&&(C["chat-manual-init"]||C["disable-offline"]&&!x||C["disable-office-hours"]&&!C["office-hours"]||C["chat-login-init"]&&!F.login())||q.initChat(),C.cron&&setTimeout(function(){N.ajax({function:"cron-jobs"})},1e4),C["cron-email-piping"]&&setTimeout(function(){N.ajax({function:"email-piping"})},8e3),C["push-notifications-users"]&&L.initServiceWorker(),y&&(C["tickets-default-department"]&&(q.default_department=C["tickets-default-department"]),C["dialogflow-disable-tickets"]&&(C["dialogflow-active"]=!1)),F.aecommerce.cart(),N.event("SBReady")}),q.audio&&(q.audio.volume=.6),q.audio_out&&(q.audio_out.volume=.6)),e(u).on("keydown","textarea",function(e){if(13==e.which&&(!y||C["tickets-enter-button"])&&(!_||!e.ctrlKey))return q.submit(),e.preventDefault,!1;_&&13==e.which&&e.ctrlKey&&q.insertText("\n")}),typeof SB_DEFAULT_DEPARTMENT!==E&&(q.default_department=SB_DEFAULT_DEPARTMENT),typeof SB_DEFAULT_AGENT!==E&&(q.default_agent=SB_DEFAULT_AGENT)):N.event("SBReady"),document.addEventListener("visibilitychange",function(){N.visibilityChange(document.visibilityState)},!1),e(o).on("click",function(){q.tab_active||N.visibilityChange()}),r=o,_&&(o=o.find(".sb-conversation")),e(m).on("scroll",function(e){q.scrollHeader()}),e(d).on("click",".sb-menu-btn",function(){let t=e(this).parent().find(".sb-menu"),i=e(t).sbActive();N.deactivateAll(),i||(e(t).sbActivate(),N.deselectAll(),_&&(SBAdmin.open_popup=t))}),$&&(e(u).on("click",".sb-textarea",function(){o.addClass("sb-header-hidden"),e(this).find("textarea").focus(),m[0].scrollTop===m[0].scrollHeight-m[0].offsetHeight&&(q.scrollBottom(),setTimeout(()=>{q.scrollBottom()},200))}),e(u).on("focusout",".sb-textarea",function(){setTimeout(()=>{o.removeClass("sb-header-hidden")},300)}),e(u).on("click",".sb-submit",function(){h.blur()}),window.addEventListener("popstate",function(){q.chat_open&&q.open(!1)})),e(d).on("click",".sb-menu li",function(){e(this).parent().sbActivate(!1)}),e(u).on("click",".sb-submit",function(){q.submit()}),e("body").on("click",".sb-chat-btn,.sb-responsive-close-btn,#sb-open-chat,.sb-open-chat",function(){q.open(!q.chat_open)}),e(o).on("click",".sb-dashboard-btn",function(){q.showDashboard(),m.find(" > .sb-panel-articles > .sb-article").length&&q.showArticles(),i("open-conversation",0),B=!1}),e(o).on("click",".sb-user-conversations li",function(){q.openConversation(e(this).attr("data-conversation-id"))}),e(o).on("click",".sb-btn-new-conversation,.sb-departments-list > div",function(){N.null(e(this).data("id"))||(q.default_department=parseInt(e(this).data("id"))),B="new-conversation",q.clear(),q.hideDashboard()}),e(o).on("click",".sb-btn-all-conversations",function(){o.find(".sb-dashboard-conversations").removeClass("sb-conversations-hidden")}),e(u).on("click",".sb-btn-attachment",function(){q.is_busy||u.find(".sb-upload-files").val("").click()}),e(u).on("click",".sb-attachments > div > i",function(t){return e(this).parent().remove(),""==h.val()&&0==u.find(".sb-attachments > div").length&&q.activateBar(!1),t.preventDefault(),!1}),e(u).on("change",".sb-upload-files",function(t){q.busy(!0),e(this).sbUploadFiles(function(e){q.uploadResponse(e)}),N.event("SBAttachments")}),e(u).on("dragover",function(t){e(this).addClass("sb-drag"),clearTimeout(w),t.preventDefault(),t.stopPropagation()}),e(u).on("dragleave",function(t){w=setTimeout(()=>{e(this).removeClass("sb-drag")},200),t.preventDefault(),t.stopPropagation()}),e(u).on("drop",function(t){let i=t.originalEvent.dataTransfer.files;if(t.preventDefault(),t.stopPropagation(),i.length>0)for(var s=0;s<i.length;++s){let e=new FormData;e.append("file",i[s]),N.upload(e,function(e){q.uploadResponse(e)})}return e(this).removeClass("sb-drag"),!1}),e(o).on("click",".sb-btn-all-articles",function(){q.showArticles()}),e(o).on("click",".sb-articles > div:not(.sb-title)",function(){q.showArticles(e(this).attr("data-id"))}),e(o).on("click",".sb-dashboard-articles .sb-input-btn .sb-submit-articles",function(){q.searchArticles(e(this).parent().find("input").val(),this,e(this).parent().next())}),e(o).on("click",".sb-article [data-rating]",function(){q.articleRatingOnClick(this)}),e(d).on("click",".sb-rich-button a",function(t){let i=e(this).attr("href");if(0===i.indexOf("#")&&0===i.indexOf("#article-"))return q.showArticles(i.replace("#article-","")),t.preventDefault(),!1}),e(r).on("click",".sb-lightbox-media > i",function(){return r.find(".sb-lightbox-media").sbActivate(!1),_&&(SBAdmin.open_popup=!1),!1}),e(o).on("click",".sb-image",function(){N.lightbox(e(this).html())}),e(o).on("click",".sb-slider-images .sb-card-img",function(){N.lightbox(`<img src="${e(this).attr("data-value")}" />`)}),e(document).on("SBConversationLoaded",function(){i("queue")&&q.queue(i("queue"))}),e(u).on("click",".sb-btn-emoji",function(){q.showEmoji(this)}),e(f).on("click",".sb-emoji-list li",function(t){q.insertEmoji(e(this).html()),$&&clearTimeout(w)}),e(f).find(".sb-emoji-list").on("touchend",function(e){w=setTimeout(()=>{q.mouseWheelEmoji(e)},50)}),e(f).find(".sb-emoji-list").on("mousewheel DOMMouseScroll",function(e){q.mouseWheelEmoji(e)}),e(f).find(".sb-emoji-list").on("touchstart",function(e){q.emoji_options.touch=e.originalEvent.touches[0].clientY}),e(f).on("click",".sb-emoji-bar > div",function(){q.clickEmojiBar(this)}),e(f).on("click",".sb-select li",function(){q.categoryEmoji(e(this).data("value"))}),e(f).find(".sb-search-btn input").on("change keyup paste",function(){q.searchEmoji(e(this).val())}),e(h).on("keyup",function(){q.textareaChange(this)}),e(o).on("click",".sb-privacy .sb-approve",function(){i("privacy-approved",!0),e(this).closest(".sb-privacy").remove(),o.removeClass("sb-init-form-active"),g.find(" > div").css({opacity:1,top:0}),q.initChat(),y?SBTickets.showPanel("new-ticket"):q.isInitDashboard()||q.hideDashboard()}),e(o).on("click",".sb-privacy .sb-decline",function(){let t=e(this).closest(".sb-privacy");e(t).find(".sb-text").html(e(t).attr("data-decline")),e(t).find(".sb-decline").remove(),q.scrollBottom(!0)}),e(o).on("click",".sb-popup-message .sb-icon-close",function(){q.popup(!0)}),e(o).on("click",".sb-rich-message .sb-submit,.sb-rich-message .sb-select ul li",function(){let t=e(this).closest(".sb-rich-message");t[0].hasAttribute("disabled")||P.submit(t,t.attr("data-type"),this)}),e(o).on("click",".sb-rich-message .sb-input > span",function(){e(this).sbActivate(),e(this).siblings().focus()}),e(o).on("focus focusout click",".sb-rich-message .sb-input input,.sb-rich-message .sb-input select",function(t){switch(t.type){case"focusin":case"focus":e(this).siblings().sbActivate();break;case"focusout":""==e(this).val()?e(this).siblings().sbActivate(!1):e(this).siblings().addClass("sb-filled sb-active");break;case"click":e(this).siblings().removeClass("sb-filled")}}),e(o).on("click",".sb-slider-arrow",function(){P.sliderChange(e(this).closest("[id]").attr("id"),e(this).hasClass("sb-icon-arrow-right")?"right":"left")}),e(o).on("change",'.sb-rich-message [data-type="select"] select',function(){e(this).siblings().sbActivate()}),e(o).on("click",'[data-type="select-input"] > div',function(){e(this).prev().sbActivate(),e(this).next().addClass("sb-focus")}),e(o).on("focusout",'[data-type="select-input"] input,[data-type="select-input"] select',function(){let t=e(this).closest(".sb-input");t.find("input").val()+t.find("select").val()==""&&t.find("span").sbActivate(!1),t.find(".sb-focus").removeClass("sb-focus")}),e(o).on("click",".sb-rich-registration .sb-login-area",function(){e(this).closest(".sb-rich-registration").replaceWith(P.generate({},"login","sb-init-form")),q.scrollBottom(!0)}),e(o).on("click",".sb-rich-login .sb-registration-area",function(){C["registration-link"]?document.location=C["registration-link"]:(e(this).closest(".sb-rich-login").replaceWith(P.generate({},"registration","sb-init-form")),q.scrollBottom(!0))}),e(o).on("click",".sb-rich-login .sb-submit-login",function(){N.loginForm(this,!1,t=>{a(new U(t[0])),o.removeClass("sb-init-form-active"),e(this).closest(".sb-rich-login").remove(),B="open-conversation",q.initChat(),L.start(),q.isInitDashboard()||q.hideDashboard()})}),e(d).on("click",".sb-social-buttons div",function(){N.openWindow(e(this).attr("data-link"))}),e(d).on("click",'.sb-rich-woocommerce-button a, [href="#"].sb-card-btn',function(i){let s=N.settingsStringToArray(e(this).closest(".sb-rich-message").attr("data-settings")),a="checkout"==s["link-type"]||s.checkout,n=e(this)[0].hasAttribute("data-ids")?e(this).attr("data-ids").split(","):[s.id.split("|")[e(this).parent().index()]];if(n.length){if(t(this))return;F.wordpress.ajax("button-purchase",{product_ids:n,checkout:a,coupon:s.coupon},t=>{a?document.location=t:e(this).addClass("sb-icon-check").sbLoading(!1)})}return i.preventDefault(),!1}),e(d).on("click","#sb-waiting-list .sb-submit",function(){0==e(this).index()&&setTimeout(()=>{F.woocommerce.waitingList("submit")},1e3)}),e(document).on("SBNewEmailAddress",function(e,t){"sb-waiting-list-email"==t.id&&F.woocommerce.waitingList("submit")}),e(r).on("click",".sb-search-btn > i",function(){let t=e(this).parent(),i=e(t).sbActive();i&&(e(t).find("input").val(""),setTimeout(function(){e(t).find("input").trigger("change")},550)),e(t).sbActivate(!i),e(t).find("input").focus(),r.find(".sb-select ul").sbActivate(!1)}),e(r).on("click",".sb-select",function(){let t=e(this).find("ul");t.toggleClass("sb-active"),_&&(SBAdmin.open_popup=!!t.hasClass("sb-active")&&this)}),e(r).on("click",".sb-select li",function(){let t=e(this).closest(".sb-select"),i=e(this).data("value");var s=e(t).find(`[data-value="${i}"]`);e(t).find("li").sbActivate(!1),e(t).find("p").attr("data-value",i).html(e(s).html()),e(s).sbActivate()}),e(r).on("click",".sb-input-image .image",function(){l=e(this).parent(),u.find(".sb-upload-files").click()}),e(r).on("click",".sb-input-image .image > .sb-icon-close",function(t){return e(this).parent().removeAttr("data-value").css("background-image",""),t.preventDefault(),!1})}var o,r,l,c,d,u,h,g,p,f,m,v,b,_=!1,y=!1,w=!1,k=!1,S=[],A=document.title,C={},$=e(window).width()<429,T=new Date,B="",x=!1,E="undefined",j=!0,I=6e4*(new Date).getTimezoneOffset(),M=!1,R=!1;e.fn.extend({manualExpandTextarea:function(){var t=this[0];t.style.height="auto",t.style.maxHeight="25px",window.getComputedStyle(t),t.style.height=(t.scrollHeight>350?350:t.scrollHeight)+"px",t.style.maxHeight="",e(t).trigger("textareaChanged")},autoExpandTextarea:function(){var t=this[0];t.addEventListener("input",function(i){e(t).manualExpandTextarea()},!1)}}),function(){var e=[].slice;String.prototype.autoLink=function(){var t,i,s,a,n,o,r;return o=/(^|[\s\n]|<[A-Za-z]*\/?>)((?:https?|ftp):\/\/[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~()_|])/gi,0<(n=1<=arguments.length?e.call(arguments,0):[]).length?(a=n[0],t=a.callback,s=function(){var e;for(i in e=[],a)r=a[i],"callback"!==i&&e.push(" "+i+"='"+r+"'");return e}().join(""),this.replace(o,function(e,i,a){return""+i+(("function"==typeof t?t(a):void 0)||"<a href='"+a+"'"+s+">"+a+"</a>")})):this.replace(o,"$1<a href='$2'>$2</a>")}}.call(this);var N={ajax:function(t,i=!1){t["login-cookie"]=this.loginCookie(),"user_id"in t||!a()||(t.user_id=a().id),"language"in t||typeof SB_LANG==E||(t.language=SB_LANG),M&&(t.cloud=M),e.ajax({method:"POST",url:SB_AJAX_URL,data:t}).done(e=>{let s;if(Array.isArray(e))s=e;else try{s=JSON.parse(e)}catch(i){return q.is_busy_update=!1,q.busy(!1),console.log(e),void N.error(e.length>500?e.substr(0,500)+"... Check the console for more details.":e,`SBF.ajax.${t.function}`)}"success"==s[0]?0!=i&&i(s[1]):N.errorValidation(s)?0!=i&&i(s):(_&&"security-error"==s[1]&&setTimeout(()=>{N.reset()},1e3),q.is_busy_update=!1,q.busy(!1),N.error(s[1]+(N.null(s[2])?"":"\nFunction name: "+s[2])+(N.null(s[3])?"":"\nError message: "+("string"==typeof s[3]?s[3]:"error"in s[3]&&"message"in s[3].error?`${s[3].error.message} in function '${s[3].error.function}'`:s[3])),`SBF.ajax.${t.function}`))})},cors:function(e="GET",t,i){let s=new XMLHttpRequest;if("withCredentials"in s)s.open(e,t,!0);else{if(typeof XDomainRequest==E)return!1;(s=new XDomainRequest).open(e,t)}s.onload=function(){i(s.responseText)},s.onerror=function(){return!1},s.send()},upload:function(e,t){M&&e.append("cloud",M),jQuery.ajax({url:SB_URL+"/include/upload.php",cache:!1,contentType:!1,processData:!1,data:e,type:"POST",success:function(e){t(e)}})},UTC:function(e){return new Date(e).getTime()-I},null:function(e){return typeof e===E||null===e||"null"===e||!1===e||!(e.length>0||"number"==typeof e||typeof e.length==E)||e===E},deactivateAll:function(){r.find(".sb-popup, .sb-tooltip, .sb-list .sb-menu, .sb-select ul").sbActivate(!1)},deselectAll:function(){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},getURL:function(e=!1,t=!1){if(0==t&&(t=location.search),0==e){for(var i=t.split("?").pop().split("&"),s={},a=0;a<i.length;a++){var n=i[a].split("=");s[n[0]]=N.escape(n[1])}return s}return t.indexOf("?")>0&&(t=t.substr(0,t.indexOf("?"))),N.escape(decodeURIComponent((new RegExp("[?|&]"+e+"=([^&;]+?)(&|#|;|$)").exec(t)||[,""])[1].replace(/\+/g,"%20")||""))},restoreJson:function(e){return N.null(e)?"":"string"!=typeof e?"":e.replace(/\\n/g,"\n").replace(/\\r/g,"\r").replace(/\\t/g,"\t").replace(/\\f/g,"\f").replace(/\\'/g,"'").replace(/\\"/g,'"').replace(/\\\\/g,"\\")},stringToSlug:function(e){e=(e=e.trim()).toLowerCase();for(var t="åàáãäâèéëêìíïîòóöôùúüûñç·/_,:;",i=0,s=t.length;i<s;i++)e=e.replace(new RegExp(t.charAt(i),"g"),"aaaaaaeeeeiiiioooouuuunc------".charAt(i));return e.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-+/,"").replace(/-+$/,"").replace(/ /g,"")},slugToString:function(e){return(e=e.replace(/_/g," ").replace(/-/g," ")).charAt(0).toUpperCase()+e.slice(1)},random:function(){let e="";for(var t=5;t>0;--t)e+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return e},isAgent:function(e){return"agent"==e||"admin"==e||"bot"==e},beautifyTime:function(e,t=!1,i=!1){let a;if("0000-00-00 00:00:00"==e)return"";if(e.indexOf("-")>0){let t=e.split(/[- :]/);a=new Date(t[0],t[1]-1,t[2],t[3],t[4],t[5])}else{let t=e.split(/[. :]/);a=new Date(t[2],t[1]-1,t[0],t[3],t[4],t[5])}let n=new Date(Date.UTC(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds())),o=Math.round((new Date-n)/864e5)*(i?-1:1),r=[s("Sunday"),s("Monday"),s("Tuesday"),s("Wednesday"),s("Thursday"),s("Friday"),s("Saturday")],l=n.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return o<1?(t?s("Today")+" ":"")+l:o<8?`<span>${r[n.getDay()]}</span>${t?` <span>${l}</span>`:""}`:`<span>${n.toLocaleDateString()}</span>${t?` <span>${l}</span>`:""}`},unix:function(e){let t=e.split(/[- :]/);return Date.UTC(t[0],t[1]-1,t[2],t[3],t[4],t[5])},getLocationTimeString:function(e,t){if("timezone"in e){let i={};i.timezone=e.timezone.value,i.country="country"in e?e.country.value:i.timezone.split("/")[0].replace(/_/g," "),i.city="city"in e?e.city.value:i.timezone.split("/")[1].replace(/_/g," "),N.cors("GET","https://worldtimeapi.org/api/timezone/"+i.timezone,function(e){if(e=JSON.parse(e),N.null(e)||!N.null(e.error))N.error(e,"SBF.getLocationTimeString()"),t(responseonSuccess);else{let a=e.datetime.replace("T"," ");t(`${new Date(a.substr(0,a.indexOf("."))).toLocaleString([],{hour:"2-digit",minute:"2-digit"})} ${s("in")} ${i.city?i.city:""}${i.country?", "+i.country:""}`)}})}},dateDB:function(e){return"now"==e?((e=(new Date).toISOString().replace("T"," ")).indexOf(".")>0&&(e=e.substr(0,e.indexOf("."))),e):`${e.getFullYear()}-${e.getMonth()+1}-${e.getDate()} ${e.getHours()}:${e.getMinutes()}:${e.getSeconds()}`},updateUsersActivity:function(e,t,i){L.active?i(L.online_ids.includes(t)?"online":"offline"):N.ajax({function:"update-users-last-activity",user_id:e,return_user_id:t,check_slack:!_&&C["slack-active"]},e=>{i("online"===e?"online":"offline")})},search:function(e,t){(e=e.toLowerCase())!=c?(clearTimeout(w),w=setTimeout(function(){c=e,t()},200)):r.find(".sb-search-btn i").sbLoading(!1)},searchClear:function(t,i){e(t).next().val()&&(e(t).next().val(""),i())},error:function(e,t){if(!_||!SBAdmin.is_logout)throw e instanceof Error&&(e=e.message),"."==e[e.length-1]&&(e=e.slice(0,-1)),e.includes("Support Board Error")&&(e=e.replace("Support Board Error ","").replace("]:","]")),_&&e&&!t.includes("update-users-last-activity")&&!t.startsWith("security-error")&&SBAdmin.dialog(`[Error] [${t}] ${e}. Check the console for more details.`,"info"),r.find(".sb-loading").sbLoading(!1),N.event("SBError",{message:e,function_name:t}),new Error(`Support Board Error [${t}]: ${e}.`)},errorValidation:function(e,t=!0){return Array.isArray(e)&&"validation-error"===e[0]&&(!0===t||e[1]==t)},loginForm:function(t,i=!1,a=!1){if(!(t=e(t)).sbLoading()){i=!1===i?t.closest(".sb-rich-login"):e(i);let n=e.trim(i.find("#email input").val()),o=e.trim(i.find("#password input").val());""==n||""==o?i.find(".sb-info").html(s("Please insert email and password.")).sbActivate():(N.ajax({function:"login",email:n,password:o},e=>{0!=e&&Array.isArray(e)?!_&&this.isAgent(e[0].user_type)?(G.showErrorMessage(i,"You cannot sign in as an agent."),q.scrollBottom()):(N.loginCookie(e[1]),N.event("SBLoginForm",new U(e[0])),!1!==a&&a(e)):(i.find(".sb-info").html(s("Invalid email or password.")).sbActivate(),_||q.scrollBottom()),t.sbLoading(!1)}),i.find(".sb-info").html("").sbActivate(!1),t.sbLoading(!0))}},loginCookie:function(e=!1){if(C.cloud){if(!1===e)return i("login");i("login",e)}else{if(!1===e)return this.cookie("sb-login");this.cookie("sb-login",e,3650,"set")}},login:function(e="",t="",i="",s="",a=!1){N.ajax({function:"login",email:e,password:t,user_id:i,token:s},e=>!(0==e||!Array.isArray(e))&&(this.loginCookie(e[1]),a&&a(e),!0))},logout:function(e=!0){q.stopRealTime(),this.cookie("sb-login","","",!1),this.cookie("sb-cloud","","",!1),i("open-conversation",""),i("login",""),q.conversations=!1,a(!1),typeof sb_beams_client!==E&&sb_beams_client.stop(),N.ajax({function:"logout"},()=>{N.event("SBLogout"),e&&setTimeout(()=>{location.reload()},500)})},activeUser:function(){return a()},getActiveUser:function(e=!1,t){let s=F.login();!s&&(i("wp-login")||i("whmcs-login")||i("perfex-login")||i("aecommerce-login"))&&(this.cookie("sb-login","","","delete"),a(!1),i("login",""),i("wp-login",""),i("whmcs-login",""),i("perfex-login",""),i("aecommerce-login","")),N.ajax({function:"get-active-user",db:e,login_app:s,user_token:N.getURL("token")},e=>{if(!e)return t(),!1;if("cookie"in e&&N.loginCookie(e.cookie),"user_type"in e)if(!_&&N.isAgent(e.user_type)){let e="You are logged in as both agent and user. Logout or use another browser, Incognito or Private mode, to login as user. Force a logout by running the function SBF.reset() in the console.";i("double-login-alert")||(i("double-login-alert",!0),alert(e)),console.warn("Support Board: "+e),N.event("SBDoubleLoginError")}else a(new U(e,"phone"in e?{phone:e.phone}:{})),L.start(),s&&i(s[1]+"-login",!0),t()})},reset:function(){let e=["sb-login","sb-cloud","sb-dialogflow-disabled"];for(var t=0;t<e.length;t++)this.cookie(e[t],"",0,!1);try{localStorage.removeItem("support-board")}catch(e){}this.logout()},lightbox:function(t){let i=e(_?r:o).find(".sb-lightbox-media");i.sbActivate().find(" > div").html(t),_&&(SBAdmin.open_popup=i)},storage:function(e,t=E){try{if(typeof localStorage==E)return!1}catch(e){return!1}let i=localStorage.getItem("support-board");if(i=null===i?{}:JSON.parse(i),t===E)return e in i&&i[e];""==t?delete i[e]:i[e]=t,localStorage.setItem("support-board",JSON.stringify(i))},storageTime:function(e,t=!1){if(!1!==t)return 0==i(e)||T.getTime()-i(e)>36e5*t;i(e,T.getTime())},cookie:function(e,t=!1,i=!1,s="get",a=!1){let n="https:"==location.protocol?"SameSite=None;Secure;":"",o=window[_?"SB_ADMIN_SETTINGS":"CHAT_SETTINGS"],r=o&&o["cookie-domain"]?"domain="+o["cookie-domain"]+";":"";if("get"==s){if(!j)return this.storage(e);let t=document.cookie.split(";");for(var l=0;l<t.length;l++){for(var c=t[l];" "==c.charAt(0);)c=c.substring(1);if(0==c.indexOf(e)){let t=c.substring(e.length+1,c.length);return!this.null(t)&&t}}return!1}if("set"==s)if(j){let s=new Date;s.setTime(s.getTime()+i*(a?1:86400)*1e3),document.cookie=e+"="+t+";expires="+s.toUTCString()+";path=/;"+n+r}else this.storage(e,t);else this.cookie(e)&&(j?document.cookie=e+"="+t+";expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/;"+n+r:this.storage(e,""))},setting:function(e){return typeof C!==E&&e in C?C[e]:-1},shortcode:function(e){return P.shortcode(e)},event:function(t,i){e(document).trigger(t,i),this.setting("webhooks")&&["SBSMSSent","SBLoginForm","SBUserDeleted","SBMessageSent","SBBotMessage","SBEmailSent","SBNewMessagesReceived","SBNewConversationReceived","SBNewConversationCreated","SBActiveConversationStatusUpdated","SBSlackMessageSent","SBMessageDeleted","SBRegistrationForm","SBRichMessageSubmit","SBNewEmailAddress"].includes(t)&&N.ajax({function:"webhooks",function_name:t,parameters:i})},translate:function(e){if(!_&&N.null(C)||_&&typeof SB_TRANSLATIONS===E)return e;let t=_?SB_TRANSLATIONS:C.translations;return t&&e in t?""==t[e]?e:t[e]:e},escape:function(e){return e?e.replaceAll("<script","&lt;script").replaceAll("</script","&lt;/script").replaceAll("javascript:","").replaceAll("onclick=","").replaceAll("onerror=",""):e},visibilityChange:function(e=""){"hidden"==e?(_||q.stopRealTime(),q.tab_active=!1):(a()&&!_&&q.startRealTime(),q.tab_active=!0,clearInterval(k),document.title=A)},settingsStringToArray:function(e){if(this.null(e))return[];let t=[];e=e.split(",");for(var i=0;i<e.length;i++){let s=e[i].split(":");t[s[0]]="false"!=s[1]&&("true"==s[1]||s[1])}return t},openWindow:function(e,t=550,i=350){let s=screen.width/2-t/2,a=screen.height/2-i/2;return window.open(e,"targetWindow","toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width="+t+",height="+i+", top="+a+", left="+s),!1},convertUTCDateToLocalDate:function(e,t=0){return e=new Date(e),e=new Date(e.getTime()+36e5*t),new Date(e.getTime()+-1*I)},loadResource:function(e,t=!1){let i=document.getElementsByTagName("head")[0],s=document.createElement(t?"script":"link");t?s.src=e+"?v=3.3.8":(s.id="support-board",s.rel="stylesheet",s.type="text/css",s.href=e+"?v=3.3.8",s.media="all"),i.appendChild(s)},debounce:function(e,t,i=500){t in S||(S[t]=!0,e(),setTimeout(()=>{delete S[t]},i))}},L={channels:{},channels_presence:[],active:!1,pusher:!1,started:!1,pusher_beams:!1,initialized:!1,online_ids:[],init_push_notifications:!1,init:function(t=!1){if(L.active){if(this.pusher)return!t||t();if(!t)return;e(window).one("SBPusherInit",()=>{t()}),this.initialized=!0,e.getScript("https://js.pusher.com/7.0/pusher.min.js",()=>{this.pusher=new Pusher(_?SB_ADMIN_SETTINGS["pusher-key"]:C["pusher-key"],{cluster:_?SB_ADMIN_SETTINGS["pusher-cluster"]:C["pusher-cluster"],authEndpoint:SB_URL+"/include/pusher.php",auth:{params:{login:N.loginCookie()}}}),N.event("SBPusherInit")})}},initPushNotifications:function(){(a()||_)&&e.getScript("https://js.pusher.com/beams/1.0/push-notifications-cdn.js",()=>{window.navigator.serviceWorker.ready.then(e=>{this.pusher_beams=new PusherPushNotifications.Client({instanceId:_?SB_ADMIN_SETTINGS["push-notifications-id"]:C["push-notifications-id"],serviceWorkerRegistration:e}),this.pusher_beams.start().then(()=>this.pusher_beams.setDeviceInterests(_?[SB_ACTIVE_AGENT.id,"agents"]:[a().id,"users"])).catch(console.error),this.init_push_notifications=!1})})},initServiceWorker:function(){"serviceWorker"in navigator&&(navigator.serviceWorker.register(_?SB_URL+"/sw.js?v=3.3.8":C["push-notifications-url"]+"?v=3.3.8").then(function(e){e.update()}).catch(function(e){console.warn(e)}),navigator.serviceWorker.onmessage=function(e){_&&e.data.conversation_id&&(SBAdmin.conversations.openConversation(e.data.conversation_id,e.data.user_id),SBAdmin.conversations.update()),_||"sb-open-chat"!=e.data||q.open()})},start:function(){_||this.started||!a()||(this.active&&this.init(()=>{this.event("client-typing",e=>{e.user_id==q.agent_id&&q.conversation&&e.conversation_id==q.conversation.id&&(q.typing(-1,"start"),clearTimeout(w),w=setTimeout(()=>{q.typing(-1,"stop")},1e3))}),this.event("new-message",()=>{q.update()}),this.presence(),this.started=!0,q.automations.run_all()}),C["push-notifications"]&&(typeof Notification!=E&&"granted"==Notification.permission?this.initPushNotifications():this.init_push_notifications=!0))},subscribe:function(e,t=!1){if(!this.pusher)return this.init(()=>{this.subscribe(e,t)});e=this.cloudChannelRename(e);let i=this.pusher.subscribe(e);i.bind("pusher:subscription_error",e=>console.log(e)),i.bind("pusher:subscription_succeeded",()=>{this.channels[e]=i,t&&t()})},event:function(e,t,i="private-user-"+a().id){if(!this.pusher)return this.init(()=>{this.event(e,t,i)});let s=i;(i=this.cloudChannelRename(i))in this.channels?(this.channels[i].unbind(e),this.channels[i].bind(e,e=>{t(e)})):this.subscribe(s,()=>{this.event(e,t,s)})},trigger:function(e,t={},i="private-user-"+a().id){if(0==e.indexOf("client-"))return this.channels[this.cloudChannelRename(i)].trigger(e,t);N.ajax({function:"pusher-trigger",channel:i,event:e,data:t},e=>e)},presence:function(e=1,t){if(!this.pusher)return this.init(()=>{this.presence()});let i=this.pusher.subscribe("presence-"+e);i.bind("pusher:subscription_succeeded",i=>{if(i.count>98)return this.subscribe(e+1);i.each(e=>{this.presenceCheck(e)&&this.online_ids.push(e.id)}),q.updateUsersActivity(),t&&t()}),i.bind("pusher:subscription_error",e=>console.log(e)),i.bind("pusher:member_added",e=>{this.presenceCheck(e)&&this.presenceAdd(e.id)}),i.bind("pusher:member_removed",e=>{this.presenceRemove(e.id)}),this.channels_presence.push(i),!_&&C["slack-active"]&&(this.event("add-user-presence",e=>{this.presenceAdd(e.agent_id)}),N.ajax({function:"slack-presence",list:!0},e=>{for(var t=0;t<e.length;t++)this.presenceAdd(e[t]);q.updateUsersActivity()}))},presenceCheck:function(e){let t=N.isAgent(e.info.user_type);return(_&&!t||!_&&t)&&!this.online_ids.includes(e.id)},presenceAdd:function(e){typeof e==E||this.online_ids.includes(e)||(this.online_ids.push(e),this.presenceUpdateAdmin(e),q.updateUsersActivity())},presenceRemove:function(e){if(typeof e==E)return;let t=this.online_ids.indexOf(e);-1!==t?(this.online_ids.splice(t,1),this.presenceUpdateAdmin(e),q.updateUsersActivity()):_&&r.find(`.sb-conversation-busy[data-agent="${e}"]`).remove()},presenceUnsubscribe:function(){for(var e=0;e<this.channels_presence.length;e++)this.channels_presence[e].unsubscribe("presence-"+(e+1))},presenceUpdateAdmin:function(e){_&&(r.find(".sb-area-users.sb-active").length&&SBAdmin.users.update(),a()&&a().id==e&&SBAdmin.users.updateUsersActivity())},pushNotification:function(e){let t=_?SB_ACTIVE_AGENT.profile_image:a().image;N.ajax({function:"push-notification",title:_?SB_ACTIVE_AGENT.full_name:a().name,message:(new D).strip(e),icon:t.indexOf("user.svg")>0?C["notifications-icon"]:t,interests:q.getRecipientUserID(),conversation_id:0!=q.conversation&&q.conversation.id},e=>e)},cloudChannelRename:function(e){return C.cloud||_&&SB_ADMIN_SETTINGS.cloud?e+"-"+(_?SB_ADMIN_SETTINGS.cloud.cloud_user_id:C.cloud.cloud_user_id):e}};window.SBF=N,window.SBPusher=L,window.sb_current_user=!1,e.fn.sbActivate=function(t=!0){return e(this).setClass("sb-active",t),this},e.fn.sbActive=function(){return e(this).hasClass("sb-active")},e.fn.sbLoading=function(t="check"){return"check"==t?e(this).hasClass("sb-loading"):(e(this).setClass("sb-loading",t),this)},e.fn.sbTogglePopup=function(t=!1){let i=!0;return _&&(SBAdmin.open_popup=!1),e(this).sbActive()?(e(this).sbActivate(!1),r.removeClass("sb-popup-active"),i=!1):(r.addClass("sb-popup-active"),r.find(".sb-popup").sbActivate(!1),t&&e(this).css("left",e(t).offset().left+15).sbActivate(),_&&setTimeout(()=>{SBAdmin.open_popup=this},500),N.deselectAll()),i},e.fn.sbUploadFiles=function(t){let i=e(this).prop("files");for(var s=0;s<i.length;s++){let e=i[s],a=new FormData;a.append("file",e),N.upload(a,t)}e(this).value=""},e.fn.setProfile=function(t=!1,i=!1){return N.null(t)&&(t=a()?a().name:""),N.null(i)&&(i=a()?a().image:SB_URL+"/media/user.svg"),e(this).find("img").attr("src",i),e(this).find(".sb-name").html(t),this},e.fn.setClass=function(t,i=!0){return i?e(this).addClass(t):e(this).removeClass(t),this};class U{constructor(e={},t={}){this.details=e,this.extra=t,this.conversations=[],this.processArray(e)}get id(){return""==this.get("id")?this.get("user_id"):this.get("id")}get type(){return this.get("user_type")}get name(){return"first_name"in this.details?this.details.first_name+(this.details.last_name?" "+this.details.last_name:""):""}get nameBeautified(){return"last_name"in this.details&&"#"!=this.details.last_name.charAt(0)?this.name:C["visitor-default-name"]}get image(){return this.get("profile_image")}get language(){let e=this.getExtra("language");return e||(e=this.getExtra("browser_language")),e?e.value.toLowerCase():""}get(e){return e in this.details&&!N.null(this.details[e])?this.details[e]:""}getExtra(e){return e in this.extra&&!N.null(this.extra[e])?this.extra[e]:""}set(e,t){this.details[e]=t}setExtra(e,t){this.extra[e]=t}processArray(e){if(e&&"details"in e){for(var t=0;t<e.details.length;t++)this.setExtra(e.details[t].slug,e.details[t]);delete e.details,this.details=e}}update(e){this.id?N.ajax({function:"get-user",user_id:this.id,extra:!0},t=>{this.processArray(t),e()}):N.error("Missing user ID","SBUser.update")}getConversations(e=!1,t){this.id?N.ajax({function:"get-user-conversations",user_id:this.id,exclude_id:t},t=>{let i=[];for(var s=0;s<t.length;s++){let e=new O([new D(t[s])],{id:t[s].conversation_id,conversation_status_code:t[s].conversation_status_code,department:t[s].department,title:t[s].title});i.push(e)}this.conversations=i,e&&e(i)}):N.error("Missing user ID","SBUser.getConversations")}getConversationsCode(e=!1){let t="",i=q.conversation?q.conversation.id:-1;e||(e=this.conversations);for(var a=0;a<e.length;a++)e[a]instanceof O?t+=`<li ${i==e[a].id?'class="sb-active" ':""}data-conversation-status="${e[a].get("conversation_status_code")}" data-conversation-id="${e[a].id}" data-department="${e[a].get("department")}">${e[a].getCode()}</li>`:N.error("Conversation not of type SBConversation","SBUser.getConversationsCode");return t||(t=`<p class="sb-no-results">${s("No conversations found.")}</p>`),t}getFullConversation(e=!1,t=!1){!1!==e?N.ajax({function:"get-conversation",conversation_id:e},e=>{let i=[];if(e)for(var s=0;s<e.messages.length;s++)i.push(new D(e.messages[s]));t&&t(new O(i,!!e&&e.details))}):N.error("Missing conversation ID","SBUser.getFullConversation")}getConversationByID(e){for(var t=0;t<this.conversations.length;t++)if(this.conversations[t].id==e)return this.conversations[t];return!1}addConversation(e){if(e instanceof O){let i=e.id,s=!0;for(var t=0;t<this.conversations.length;t++)if(this.conversations[t].id==i){this.conversations[t]=e,s=!1;break}return s&&this.conversations.unshift(e),s}N.error("Conversation not of type SBConversation","SBUser.addConversation")}getLastConversation(){return!this.isConversationsEmpty()&&this.conversations[this.conversations.length-1]}isConversationsEmpty(){return 0==this.conversations.length}isExtraEmpty(){return 0===Object.keys(this.extra).length&&this.extra.constructor===Object}delete(e){this.id?N.ajax({function:"delete-user",user_id:this.id},()=>(N.event("SBUserDeleted",this.id),e(),!0)):N.error("Missing user ID","SBUser.delete")}}window.SBUser=U;class D{constructor(e={}){this.details=e,"first_name"in this.details&&(this.details.full_name=this.details.first_name+" "+this.details.last_name),this.set("payload",this.get("payload")?JSON.parse(this.get("payload")):{})}get id(){return this.get("id")}get attachments(){return N.null(this.details.attachments)?[]:JSON.parse(this.details.attachments)}get message(){return this.get("message")}get(e){return e in this.details&&!N.null(this.details[e])?this.details[e]:""}set(e,t){this.details[e]=t}payload(e=!1,t=!1){let i=this.get("payload");if(!1!==e&&!1!==t)i[e]=t,this.set("payload",i);else if(!1!==e)return e in i?i.key:"id"in i&&i.id==e&&i;return i}getCode(){let e=N.isAgent(this.details.user_type),t=_?SBAdmin.conversations.messageMenu(e):"",i=this.render(""==this.message&&"preview"in this.payload?this.payload.preview:this.message),s=this.attachments,a="",n="",o=_||e&&!C["hide-agents-thumb"]||!e&&C["display-users-thumb"]?`<div class="sb-thumb"><img src="${this.details.profile_image}"><div>${this.details.full_name}</div></div>`:"",r=(e?"":"sb-right")+(""==o?"":" sb-thumb-active"),l="";if(""==i&&0==s.length)return"";if(e){let e=i.match(/\[.+?\]/g)||[],t=!1;for(c=0;c<e.length;c++){let s=P.shortcode(e[c]),a=P.generate(s[1],s[0]);a&&("["!=i.charAt(0)&&(a=a.replace("sb-rich-message","sb-rich-message sb-margin-top")),"]"!=i.charAt(i.length-1)&&(a=a.replace("sb-rich-message","sb-rich-message sb-margin-bottom")),i=i.replace(e[c],a),t=!0,l=`data-type="${s[0]}"`)}t&&(r+=" sb-rich-cnt",e.length>1&&(l='data-type="multiple"'))}if(s.length){a='<div class="sb-message-attachments">';for(var c=0;c<s.length;c++){let e=s[c][1];/.jpg|.jpeg|.png|.gif/.test(e)?n+=`<div class="sb-image${e.includes(".png")?" sb-image-png":""}"><img src="${e}" /></div>`:a+=`<a rel="noopener" target="_blank" href="${e}">${s[c][0]}</a>`}a+="</div>"}return`<div data-id="${this.details.id}" class="${r}" ${l}>${o}<div class="sb-cnt"><div class="sb-message${n&&""==i?" sb-message-media":""}">${i}${n}</div>${a}<div class="sb-time">${N.beautifyTime(this.details.creation_time,!0)}</div></div>${t}</div>`}render(t=!1){!1===t&&(t=""+this.details.message);let i=t.length,s=t.match(/```([\s\S]*)```/)||[];for(n=0;n<s.length;n++)t=t.replace(s[n],"[code-"+n+"]");t=(t=(t=(t=(t=t.replace(/(?:\r\n|\r|\n)/g,"<br>")).replace(/\*([^\**]+)\*/g,"<b>$1</b>")).replace(/\__([^\____]+)\__/g,"<i>$1</i>")).replace(/\~([^\~~]+)\~/g,"<del>$1</del>")).replace(/\`([^\``]+)\`/g,"<code>$1</code>");let a=["cede","ubbed"];for(n=0;n<a.length;n++)t=t.replaceAll(a[n],`[U${n}]`);t=(t=t.replaceAll("uccede","[U1]")).replace(/u([0-9a-f]{4,5})/im,"&#x$1;");for(n=0;n<a.length;n++)t=t.replaceAll(`[U${n}]`,a[n]);((6==i||5==i)&&t.startsWith("&#x")||i<3&&t.match(/(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|\ud83c[\ude32-\ude3a]|\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])/))&&(t=`<span class="emoji-large">${t}</span>`),t.includes("http")&&(t=t.autoLink({target:"_blank"}));for(var n=0;n<s.length;n++)t=t.replace("[code-"+n+"]","<pre>"+e.trim(e.trim(s[n]).substr(3,s[n].length-6).replace(/(?:\r\n|\r|\n)/g,"<br>")))+"</pre>";return t}strip(e=!1){!1===e&&(e=""+this.details.message);let t=[e.match(/\*([^\**]+)\*/g),e.match(/\__([^\____]+)\__/g),e.match(/\~([^\~~]+)\~/g),e.match(/\`([^\``]+)\`/g)],i=["*","__","~","`"];for(var s=0;s<t.length;s++){let n=t[s];if(!N.null(n))for(var a=0;a<n.length;a++)e=e.replace(n[a],n[a].replaceAll(i[s],""))}return e}}window.SBMessage=D;class O{constructor(e,t){this.details=N.null(t)?{}:t,Array.isArray(e)?(this.messages=[],e.length&&(e[0]instanceof D?this.messages=e:N.error("Messages not of type SBMessage","SBConversation.constructor"))):N.error("Message array not of type Array","SBConversation.constructor")}get id(){return""==this.get("id")?this.get("conversation_id"):this.get("id")}get(e){if(e in this.details&&!N.null(this.details[e]))return this.details[e];if("title"==e){if(!N.null(this.details.first_name))return this.details.first_name+" "+this.details.last_name;if(this.messages.length)return this.messages[0].get("full_name")}return""}set(e,t){this.details[e]=t}getMessage(e){for(var t=0;t<this.messages.length;t++)if(this.messages[t].id==e)return this.messages[t].set("index",t),this.messages[t];return!1}getLastMessage(){for(var e=this.messages.length-1;e>-1;e--)if(this.messages[e].message||this.messages[e].attachments.length)return this.messages[e];return!1}getLastUserMessage(e=!1,t=!1){!1===e&&(e=this.messages.length-1);for(var i=e;i>-1;i--){let e=this.messages[i],s=e.get("user_type");if((e.message||e.attachments.length)&&(!t&&!N.isAgent(s)||!0===t&&("agent"==s||"admin"==s)||"bot"==t&&"bot"==s||"no-bot"==t&&"bot"!=s||"all"==t&&N.isAgent(s)))return this.messages[i].set("index",i-1),this.messages[i]}return!1}getUserMessages(e="user"){let t=[],i="user"==e?["visitor","lead","user"]:"agents"==e?["agent","admin"]:["bot"];for(var s=0;s<this.messages.length;s++)i.includes(this.messages[s].get("user_type"))&&t.push(this.messages[s]);return t}updateMessage(e,t){if(t instanceof D){for(var i=0;i<this.messages.length;i++)if(this.messages[i].id==e)return this.messages[i]=t,!0}else N.error("Message not of type SBMessage","SBConversation.updateMessage");return!1}addMessages(e){if(Array.isArray(e))for(var t=0;t<e.length;t++)e[t]instanceof D&&this.messages.push(e[t]);else e instanceof D?this.messages.push(e):N.error("Messages not of type SBMessage","SBConversation.addMessages()");return this}getCode(){let e=this.messages.length;if(e){let t=this.messages[e-1],i=t.message;if(!1!==i.indexOf("[")){let e=i.match(/\[.+?\]/g)||[];if(e.length){let t=P.shortcode(e[0]);i=i.replace(e[0],s(N.null(t[1].message)?N.null(t[1].title)?"":t[1].title:t[1].message))}}let a=y&&!C["tickets-conversations-title-user"]?this.get("title"):s(_||"#"!=t.get("last_name").charAt(0)?t.get("full_name"):"You");return`<div class="sb-conversation-item" data-user-id="${t.get("user_id")}"><img src="${t.get("profile_image")}"><div><span class="sb-name">${a}</span><span class="sb-time">${N.beautifyTime(t.get("creation_time"))}</span></div><div class="sb-message">${i.length>114?i.substr(0,114)+" ...":i}</div></div>`}return""}deleteMessage(e){for(var t=0;t<this.messages.length;t++)if(this.messages[t].id==e)return this.messages.splice(t,1),!0;return!1}searchMessages(e,t=!1){let i=[];for(var s=0;s<this.messages.length;s++){let a=this.messages[s].message;(t&&a==e||!t&&a.includes(e))&&i.push[messages[s]]}return i}getAttachments(){let e=[];for(var t=0;t<this.messages.length;t++){let s=this.messages[t].attachments;for(var i=0;i<s.length;i++){let a=s[i][1];e.push([s[i][0],a,a.substr(a.lastIndexOf(".")+1),this.messages[t].id])}}return e}}window.SBConversation=O;var q={rich_messages_list:["chips","buttons","select","inputs","table","list"],emoji_options:{range:0,range_limit:47,list:[],list_now:[],touch:!1},initialized:!1,editor_listening:!1,conversation:!1,is_busy:!1,is_busy_update:!1,is_busy_populate:!1,chat_open:!1,real_time:!1,agent_id:-1,agent_online:!1,user_online:!1,expanded:!1,main_header:!0,start_header:!1,desktop_notifications:!1,flash_notifications:!1,datetime_last_message:"2000-01-01 00:00:00",datetime_last_message_conversation:"2000-01-01 00:00:00",audio:!1,audio_out:!1,tab_active:!0,notifications:[],typing_settings:{typing:!1,sent:!1,timeout:!1},email_sent:!1,dashboard:!1,articles:!1,articles_categories:!1,slack_channel:[-1,-1],skip:!1,queue_interval:!1,departments:!1,default_department:null,default_agent:null,offline_message_set:!1,sendMessage:function(t=-1,i="",n=[],o=!1,r=!1,l=!1){let c=b&&F.dialogflow.active(),g=!1;if(!this.conversation){let e=!_&&a().getLastConversation();if(!e||"new-conversation"==B)return void this.newConversation(l,t,"",[],_&&SB_ACTIVE_AGENT.department?SB_ACTIVE_AGENT.department:null,null,()=>this.sendMessage(t,i,n,o,r));this.openConversation(e.id),this.setConversation(e),B=!1}-1==t&&(t=_?SB_ACTIVE_AGENT.id:a().id);let p=t!=v;i||n.length||(i=h.val().trim(),u.find(".sb-attachments > div").each(function(){n.push([e(this).attr("data-name"),e(this).attr("data-value")])}),_&&SBAdmin.must_translate&&(F.dialogflow.translate([i],a().language,e=>{e&&(r?r["original-message"]=i:r={"original-message":i},e[0].translatedText&&(i=e[0].translatedText)),this.sendMessage(t,i,n,o,r,l)}),g=!0)),this.busy(!0),p&&(h.val("").css("height",""),u.find(".sb-attachments").html("")),this.activateBar(!1),g||(!1===l&&t==v&&(l="skip"),_||!p||c||(l=2),i||n.length||r?(N.ajax({function:"send-message",user_id:t,conversation_id:this.conversation.id,message:i,attachments:n,conversation_status_code:l,queue:!_&&C.queue&&p,payload:r,recipient_id:!!_&&a().id},e=>{let s=_||!c||e.human_takeover_active;!_&&this.dashboard&&t==v&&this.updateConversations(),(_&&!this.user_online||!_&&!this.agent_online)&&this.update(),_||!p||b||(this.followUp(),this.offlineMessage()),p&&(!r||"sb-human-takeover"!=r.id&&N.null(r["skip-dialogflow"]))&&F.dialogflow.message(i,n),!_&&p&&"visitor"==a().type?N.ajax({function:"update-user-to-lead",user_id:t},()=>{a().set("user_type","lead"),C["slack-active"]&&s&&this.slackMessage(t,a().name,a().image,i,n)}):s&&!this.skip&&(_&&SB_ADMIN_SETTINGS["slack-active"]?this.slackMessage(a().id,SB_ACTIVE_AGENT.full_name,SB_ACTIVE_AGENT.profile_image,i,n):C["slack-active"]&&this.slackMessage(a().id,p?a().name:C["bot-name"],p?a().image:C["bot-image"],i,n)),p&&C["language-detection"]&&this.conversation&&i.split(" ").length>1&&!N.storage("language-detection-completed")&&(N.ajax({function:"google-language-detection-update-user",user_id:t,string:i,token:F.dialogflow.token}),N.storage("language-detection-completed",!0)),!this.articles||_||!C.articles||C["office-hours"]||this.isInitDashboard()||setTimeout(()=>{this.conversation&&(this.sendMessage(v,"[articles]"),this.scrollBottom(),this.articles=!1)},5e3),e.queue&&this.queue(this.conversation.id);let d={user_id:t,conversation_id:this.conversation.id,conversation_status_code:l,message_id:e.id,message:i,attachments:n};N.event("SBMessageSent",d),y&&SBTickets.onMessageSent(),o&&o(d),e.notifications.length&&N.event("SBNotificationsSent",e.notifications),this.skip&&(this.skip=!1),this.busy(!1)}),p&&(i=N.escape(i),d.append(new D({id:"sending",profile_image:_?SB_ACTIVE_AGENT.profile_image:a().image,full_name:a().name,creation_time:"0000-00-00 00:00:00",message:i,user_type:_?"agent":"user"}).getCode().replace('<div class="sb-time"></div>',`<div class="sb-time">${s("Sending")}<i></i></div>`)),this.dashboard||this.scrollBottom()),(this.audio&&!_&&this.chat_open&&p&&["a","aa"].includes(C["chat-sound"])||_&&"a"==SB_ADMIN_SETTINGS.sounds)&&this.audio_out.play()):this.busy(!1))},sendBotMessage:function(e="",t=[]){return F.dialogflow.message(e,t)},updateMessage:function(e,t=""){N.ajax({function:"update-message",message_id:e,message:t})},sendEmail:function(e,t,i=!1){let s=i?a().id:this.getRecipientUserID();if(!_&&!isNaN(s)&&this.agent_online)return!1;N.ajax({function:"create-email",recipient_id:s,sender_name:_?i?SB_ACTIVE_AGENT.full_name:a().name:i?C["bot-name"]:a().name,sender_profile_image:_?i?SB_ACTIVE_AGENT.profile_image:a().name:i?C["bot-image"]:a().image,message:e,attachments:t,department:!!this.conversation&&this.conversation.get("department"),conversation_id:!!this.conversation&&this.conversation.id},()=>{N.event("SBEmailSent",{recipient_id:s,message:e,attachments:t})})},sendSMS:function(e){let t=this.getRecipientUserID();if(!_&&!isNaN(t)&&this.agent_online)return!1;N.ajax({function:"send-sms",to:t,message:e,conversation_id:!!this.conversation&&this.conversation.id},t=>{"sent"==t.status||"queued"==t.status?N.event("SBSMSSent",{recipient_id:this.getRecipientUserID(),message:e,response:t}):t.message&&N.error(t.message,"SBChat.sendSMS")})},pushNotification:function(e){L.pushNotification(e)},desktopNotification:function(e,t,i,s=!1,n=!1){if("granted"!==Notification.permission)Notification.requestPermission();else{new Notification(e,{body:(new D).strip(t),icon:i.indexOf("user.svg")>0?C["notifications-icon"]:i}).onclick=(()=>{_?s&&(SBAdmin.conversations.openConversation(s,0==n?a().id:n),SBAdmin.conversations.update()):this.start(),window.focus()})}},getRecipientUserID:function(){return _?a().id:this.lastAgent(!1)?this.lastAgent(!1).user_id:N.null(this.conversation.get("agent_id"))?N.null(this.conversation.get("department"))?"agents":"department-"+this.conversation.get("department"):this.conversation.get("agent_id")},submit:function(){if(!this.is_busy){if(0==a()&&!_)return this.addUserAndLogin(()=>{this.newConversation(2,-1,"",[],null,null,()=>{this.sendMessage()})}),void this.busy(!0);this.sendMessage(),C["cron-email-piping-active"]&&(setInterval(function(){N.ajax({function:"email-piping"})},6e4),C["cron-email-piping-active"]=!1),L.init_push_notifications&&L.initPushNotifications()}},initChat:function(){_||N.getActiveUser(!0,()=>{let e=!1!==a(),t=!!e&&a().type;y||!C.popup.active||i("popup")||$&&C["popup-mobile-hidden"]||this.popup(),y||!C.privacy||C["registration-required"]||i("privacy-approved")?(typeof Notification!==E&&!C["push-notifications-users"]&&("all"==C["desktop-notifications"]||"users"==C["desktop-notifications"]||_&&"agents"==C["desktop-notifications"])&&(this.desktop_notifications=!0),("all"==C["flash-notifications"]||"users"==C["flash-notifications"]||_&&"agents"==C["flash-notifications"])&&(this.flash_notifications=!0),!this.registration(!0)||y?(e||!(typeof SB_WP_WAITING_LIST!==E||C["visitors-registration"]||C.welcome||C.subscribe||y)||y&&C["tickets-registration-required"]?!this.conversation&&e?this.populateConversations():this.finalizeInit():this.addUserAndLogin(()=>{this.welcome(),this.subscribe(),F.woocommerce.waitingList(),this.finalizeInit()}),C["header-name"]&&e&&"user"==t&&!y&&g.find(".sb-title").html(`${s("Hello")} ${a().nameBeautified}!`),this.welcome(),this.subscribe(),L.active||(setInterval(()=>{this.updateConversations(),this.updateUsersActivity()},10200),q.automations.run_all()),F.woocommerce.waitingList(),this.scrollBottom(!0)):this.registration()):this.privacy()})},finalizeInit:function(){this.initialized||(o.attr("style",""),_||y||(this.isInitDashboard()&&this.showDashboard(),!$&&window.innerHeight<760&&o.find(" > .sb-body").css("max-height",window.innerHeight-130+"px")),this.initialized=!0,_||(a()&&!this.registration(!0)&&(i("open-conversation")&&this.openConversation(i("open-conversation")),N.getURL("conversation")&&this.openConversation(N.getURL("conversation"))),(!this.chat_open&&(!$&&i("chat-open")||"open"==N.getURL("chat"))||N.getURL("conversation"))&&setTimeout(()=>{this.start()},500),C["woocommerce-returning-visitor"]&&(!1===i("returning-visitor")?N.storageTime("returning-visitor"):N.storageTime("returning-visitor",24)&&!i("returning-visitor-processed")&&setTimeout(()=>{N.ajax({function:"woocommerce-returning-visitor"},()=>{i("returning-visitor-processed",!0)})},15e3)),C["timetable-type"]&&q.offlineMessage(),C["queue-human-takeover"]&&F.dialogflow.humanTakeoverActive()&&(C.queue=!0)),y&&SBTickets.init(),N.event("SBInit"))},start:function(){this.initialized&&(this.populate(),this.headerAgent(),this.updateUsersActivity(),this.startRealTime(),this.chat_open=!0,this.popup(!0),this.conversation&&this.updateNotifications("remove",this.conversation.id),o.sbActivate(),e("body").addClass("sb-chat-open"),"open"==C["welcome-trigger"]&&this.welcome())},open:function(t=!0){t&&!this.chat_open?(this.start(),this.chat_open=!0,this.startRealTime(),o.sbActivate(),e("body").addClass("sb-chat-open"),i("chat-open",!0),$&&history.pushState({"chat-open":!0},"",""),N.event("SBChatOpen")):!t&&this.chat_open&&(o.sbActivate(!1),this.stopRealTime(),this.chat_open=!1,i("chat-open",!1),e("body").removeClass("sb-chat-open"),N.event("SBChatClose"))},openConversation:function(e){a().getFullConversation(e,t=>{if(""==t.id)return i("open-conversation",""),!1;this.setConversation(t),this.hideDashboard(),this.populate(),this.main_header=!1,i("queue")==e&&this.queue(e),(this.chat_open||y)&&this.updateNotifications("remove",e),y&&SBTickets.activateConversation(t),i("open-conversation",e),N.event("SBConversationOpen",t)})},update:function(){if(this.conversation&&!this.is_busy_update){let e=this.conversation.getLastMessage(),t=!1;N.ajax({function:"get-new-messages",conversation_id:this.conversation.id,datetime:this.datetime_last_message_conversation},s=>{let a=s.length;if(this.is_busy_update=!1,this.conversation&&Array.isArray(s)&&a>0&&(!e||e.id!=s[a-1].id||e.message!=s[a-1].message||e.payload!=s[a-1].payload||e.attachments!=s[a-1].attachments)){let e="",o=[],r=[],l=!1;for(var n=0;n<a;n++)if(!r.includes(s[n].id)){let i=new D(s[n]),a=i.payload();if(this.datetime_last_message_conversation=i.get("creation_time"),"boolean"!=typeof a){if("event"in a){let e=a.event;("delete-message"==e&&!1!==this.conversation.getMessage(i.id)||!_&&""==i.message&&!i.attachments.length)&&this.deleteMessage(i.id),"woocommerce-update-cart"!=e||_||F.woocommerce.updateCart(a.action,a.id),F.dialogflow.active()||"conversation-status-update-3"!=e&&"conversation-status-update-4"!=e&&"activate-bot"!=e||(F.dialogflow.active("activate"),l=!0)}"human-takeover"in a&&C["queue-human-takeover"]&&(C.queue=!0,q.queue(q.conversation.id))}0==this.conversation.getMessage(s[n].id)?(this.conversation.addMessages(i),e+=i.getCode()):(this.conversation.updateMessage(i.id,i),d.find(`[data-id="${i.id}"]`).replaceWith(i.getCode()),t=!0),o.push(i),r.push(i.id)}d.append(e);let c=this.conversation.getLastMessage(),u=c.get("user_type"),h=N.isAgent(u);!_&&h&&"bot"!=u&&(this.chat_open&&(-1==c.message.indexOf("sb-rich-success")&&this.setConversationStatus(0),C.follow.active&&clearTimeout(w)),l||F.dialogflow.active(!1)),i("queue")==this.conversation.id&&h&&"bot"!=u&&this.queue("clear"),d.find('[data-id="sending"]').remove(),this.headerAgent(),this.dashboard||t||(this.scrollBottom(),setTimeout(()=>{this.scrollBottom()},300)),this.typing(-1,"stop"),this.busy(!1),!this.audio||1==a&&N.null(o[0].message)&&N.null(o[0].attachments)||!(!_&&this.chat_open&&(h||"bot"==u)&&["aa","ia"].includes(C["chat-sound"])||_&&!N.isAgent(u)&&["a","i","ic"].includes(SB_ADMIN_SETTINGS.sounds))||this.audio.play(),N.event("SBNewMessagesReceived",o),y&&SBTickets.onNewMessageReceived(o[0])}}),this.is_busy_update=!0,setTimeout(()=>{this.is_busy_update=!1},5e3)}},updateConversations:function(){a()&&N.ajax({function:"get-new-user-conversations",datetime:this.datetime_last_message},e=>{if(e.length){let i=e.length;this.datetime_last_message=e[0].creation_time;for(var t=0;t<i;t++){let i=e[t].conversation_id,s=new D(e[t]),n=e[t].conversation_status_code,o=new O([s],{id:i,conversation_status_code:n,department:e[t].department,title:e[t].title}),r=a().addConversation(o);e[t].user_id==a().id||this.conversation.id==i&&this.chat_open||(this.updateNotifications("add",i),C["auto-open"]&&this.start());let l=s.payload();if("boolean"!=typeof l&&"event"in l){if("open-chat"==l.event&&((this.conversation.id!=i||this.dashboard)&&this.openConversation(i),setTimeout(()=>{this.open()},500)),""==s.message&&!s.attachments.length)continue}this.tab_active||(this.desktop_notifications&&q.desktopNotification(s.get("full_name"),s.message,s.get("profile_image")),this.flash_notifications&&this.flashNotification(),!this.audio||!["a","aa","i"].includes(C["chat-sound"])||this.chat_open&&this.tab_active&&!this.dashboard||N.null(s.message)&&N.null(s.attachments)||this.audio.play()),r&&(N.event("SBNewConversationReceived",o),y&&SBTickets.onNewConversationReceived(o))}o.find(".sb-user-conversations").html(a().getConversationsCode()),o.find(".sb-dashboard-conversations").setClass("sb-conversations-hidden",o.find(".sb-user-conversations > li").length>3)}})},populate:function(){if(this.conversation){let t="",i=d.find(" > .sb-notify-message");for(var e=0;e<this.conversation.messages.length;e++)t+=this.conversation.messages[e].getCode();d.html((i.length?i[0].outerHTML:"")+t),this.dashboard||this.scrollBottom()}else a()&&!a().isConversationsEmpty()&&this.showDashboard()},populateConversations:function(e=!1){!this.is_busy_populate&&a()&&(this.is_busy_populate=!0,setTimeout(()=>{this.is_busy_populate=!1},5e3),a().getConversations(t=>{let s=t.length;if(s){let e=Date.now();this.datetime_last_message=t[0].messages[0].get("creation_time");for(var n=0;n<s;n++)1!=t[n].get("conversation_status_code")||this.conversation&&this.conversation.id==t[n].id||this.updateNotifications("add",t[n].id),e-N.UTC(t[n].messages[0].get("creation_time"))<6e3&&this.open();o.removeClass("sb-no-conversations"),o.find(".sb-user-conversations").html(a().getConversationsCode()),o.find(".sb-dashboard-conversations").setClass("sb-conversations-hidden",o.find(".sb-user-conversations > li").length>3)}this.initialized&&"open-conversation"!=B||1!=s||this.isInitDashboard()||i("open-conversation")||(this.openConversation(a().conversations[0].id),"open-conversation"==B&&(B="")),!1!==e&&e(t),this.finalizeInit()}))},newConversation:function(e,t=-1,i="",s=[],n=null,r=null,l=!1){a()?N.ajax({function:"new-conversation",status_code:e,title:y?o.find(".sb-ticket-title input").val():null,department:N.null(n)?this.default_department:n,agent_id:N.null(r)?this.default_agent:r},a=>{if(N.errorValidation(a,"user-not-found"))return void this.addUserAndLogin(()=>{this.newConversation(e,t,i,s,n,r,l)});let o=new O([],a.details);this.setConversation(o),(i||s.length)&&this.sendMessage(t,i,s),t!=v&&this.queue(o.id),l&&l(o),N.event("SBNewConversationCreated",o)}):N.error("activeUser() not setted","SBChat.newConversation")},setConversation:function(e){e instanceof O?(this.conversation=e,this.datetime_last_message_conversation=0==this.conversation.getLastMessage()?"2000-01-01 00:00:00":this.conversation.getLastMessage().get("creation_time"),e.id!=this.conversation.id&&this.queue(e.id),i("open-conversation",e.id),N.event("SBActiveConversationChanged",e)):N.error("Value not of type SBConversation","SBChat.setConversation")},queue:function(e){if("clear"==e)return o.removeClass("sb-notify-active sb-queue-active"),d.find(" > .sb-notify-message").remove(),clearInterval(this.queue_interval),this.queue_interval=!1,void i("queue","");!_&&C.queue&&N.ajax({function:"queue",conversation_id:e,department:this.conversation.get("department")},t=>{if(d.find(" > .sb-notify-message").remove(),0==t){let e=this.conversation.getLastUserMessage().message;C["push-notifications"]&&L.pushNotification(e),this.sendMessage(v,s(""==C["queue-message-success"]?"It's your turn! An agent will reply to you shortly.":C["queue-message-success"]),[],!1,{preview:e}),this.queue("clear")}else{let a=(""==C["queue-response-time"]?5:parseInt(C["queue-response-time"]))*t,n=s(""==C["queue-message"]?"Please wait for an agent. You are number {position} in the queue. Your waiting time is approximately {minutes} minutes.":C["queue-message"]).replace("{position}","<b>"+t+"</b>").replace("{minutes}","<b>"+a+"</b>");d.prepend(`<div class="sb-notify-message sb-rich-cnt"><div class="sb-cnt"><div class="sb-message">${n}</div></div></div>`),!1===this.queue_interval&&(this.queue_interval=setInterval(()=>{this.queue(e)},10100),o.addClass("sb-notify-active sb-queue-active"),i("queue",e))}N.event("SBQueueUpdate",t)})},getDepartmentCode(e,t){if(this.departments)if("all"==e){let e="";for(var i in this.departments)this.getDepartmentCode(this.departments[i].id,t=>{e+=t});t(e)}else t(`<div data-color="${this.departments[e].color}">${""==this.departments[e].image?"<span></span>":`<img src="${this.departments[e].image}" />`}<div>${this.departments[e].name}<div></div>`);else N.ajax({function:"get-departments"},i=>{i&&(this.departments=i,this.getDepartmentCode(e,t))})},startRealTime:function(){L.active||(this.stopRealTime(),this.real_time=setInterval(()=>{this.update(),this.typing(_?a()?a().id:-1:this.agent_id,"check")},1e3))},stopRealTime:function(){clearInterval(this.real_time)},updateUsersActivity:function(){a()&&N.updateUsersActivity(a().id,this.agent_id,t=>{this.typing_settings.typing||("online"==t||this.agent_id==v?(e(p).addClass("sb-status-online").html(s("Online")),this.agent_online=this.agent_id!=v):(e(p).removeClass("sb-status-online").html(s("Away")),this.agent_online=!1))})},busy:function(e){u.find(".sb-loader").sbActivate(e),this.is_busy=e,N.event("SBBusy",e)},headerAgent:function(){if(!_&&!y&&!this.dashboard&&0!=this.conversation&&(-1==this.agent_id||0!=this.conversation.getLastMessage()&&N.isAgent(this.conversation.getLastMessage().get("user_type"))&&this.conversation.getLastMessage().get("user_id")!=this.agent_id)){let e=this.lastAgent();e&&(this.agent_id=e.user_id,this.headerReset(),g.addClass("sb-header-agent").attr("data-agent-id",this.agent_id).html(`<div class="sb-dashboard-btn sb-icon-arrow-left"></div><div class="sb-profile"><img src="${e.profile_image}" /><div><span class="sb-name">${e.full_name}</span><span class="sb-status">${s("Away")}</span></div><i class="sb-icon sb-icon-close sb-responsive-close-btn"></i></div>`),p=g.find(".sb-status"),this.updateUsersActivity(),N.storageTime("header-animation",1)&&(g.addClass("sb-header-animation"),setTimeout(()=>{g.removeClass("sb-header-animation")},8e3),N.storageTime("header-animation")))}},headerReset:function(){0==this.start_header&&(this.start_header=[g.html(),g.attr("class")]),g.removeClass("sb-header-main sb-header-brand sb-header-agent sb-header-minimal"),this.main_header=!1},lastAgent:function(e=!0){let t=!1;if(this.conversation){let i=this.conversation.getLastUserMessage(!1,!e||"all");i&&(t={user_id:i.get("user_id"),full_name:i.get("full_name"),profile_image:i.get("profile_image")})}return t},scrollBottom:function(e=!1){setTimeout(()=>{m.scrollTop(e?0:m[0].scrollHeight),this.scrollHeader()},20)},scrollHeader:function(){if(this.main_header&&this.dashboard){let e=m.scrollTop();e>-1&&e<1e3&&g.find(".sb-content").css({opacity:1-e/500,top:e/10*-1+"px"})}},showDashboard:function(){_||y||(o.addClass("sb-dashboard-active"),g.removeClass("sb-header-agent"),this.hidePanel(),this.start_header&&g.html(this.start_header[0]).addClass(this.start_header[1]),m.find(" > div").sbActivate(!1),o.find(".sb-dashboard").sbActivate(),this.populateConversations(),this.conversation=!1,this.agent_id=-1,this.stopRealTime(),this.dashboard=!0,this.main_header=!0,this.scrollBottom(!0),N.event("SBDashboard"))},hideDashboard:function(){_||y||(d.sbActivate(),o.removeClass("sb-dashboard-active").find(".sb-dashboard").sbActivate(!1),this.dashboard=!1,this.headerAgent(),this.scrollHeader(0),this.chat_open&&this.startRealTime(),N.event("SBDashboardClosed"))},showPanel:function(e,t){if(y)return SBTickets.showPanel(e,t);let i=m.find(" > .sb-panel-"+e);i.length&&(m.find(" > div").sbActivate(!1),i.sbActivate(),this.start_header||(this.start_header=[g.html(),g.attr("class")]),g.attr("class","sb-header sb-header-panel").html(`${s(t)}<div class="sb-dashboard-btn sb-icon-close"></div>`),o.addClass("sb-panel-active"),this.dashboard=!0),N.event("SBPanelActive",e)},hidePanel:function(){o.removeClass("sb-panel-active"),g.removeClass("sb-header-panel")},clear:function(){this.conversation=!1,d.html("")},updateNotifications:function(e="add",t){if("add"!=e||this.notifications.includes(t)||this.notifications.push(t),"remove"==e)for(var i=0;i<this.notifications.length;i++)if(this.notifications[i]==t){this.notifications.splice(i,1),0!=this.conversation.get("conversation_status_code")&&["1","2",1,2].includes(this.conversation.get("conversation_status_code"))&&this.setConversationStatus(0);break}let s=this.notifications.length;o.find(".sb-chat-btn span").attr("data-count",s).html(s>-1?s:0),N.event("SBNotificationsUpdate",{action:e,conversation_id:t})},setConversationStatus:function(e){return!!this.conversation&&(N.ajax({function:"update-conversation-status",conversation_id:this.conversation.id,status_code:e},()=>{this.conversation.set("conversation_status_code",e),N.event("SBActiveConversationStatusUpdated",{conversation_id:this.conversation.id,status_code:e})}),!0)},typing:function(t=-1,i="check"){if(this.conversation){let n=this.agent_online||_&&this.user_online;if("check"==i&&!L.active&&-1!=t&&t!=v&&n)N.ajax({function:"is-typing",user_id:t,conversation_id:this.conversation.id},e=>{e&&!this.typing_settings.typing?this.typing(-1,"start"):!e&&this.typing_settings.typing&&this.typing(-1,"stop")});else if("set"==i&&n){let e=this.conversation.get("source");e&&(e="fb"==e&&[e,a().getExtra("facebook-id").value,this.conversation.get("extra")]),L.active?N.debounce(()=>{L.trigger("client-typing",{user_id:_?SB_ACTIVE_AGENT.id:a().id,conversation_id:this.conversation.id}),e&&N.ajax({function:"set-typing",source:e})},"#2"):this.typing_settings.sent?(clearTimeout(this.typing_settings.timeout),this.typing_settings.timeout=setTimeout(()=>{N.ajax({function:"set-typing",user_id:t,conversation_id:-1},()=>{this.typing_settings.sent=!1})},2e3)):(this.typing_settings.sent=!0,N.ajax({function:"set-typing",user_id:t,conversation_id:this.conversation.id,source:e}),this.typing(t,"set"))}else if("start"==i||"stop"==i){let t="start"==i;if(!_&&p)if(t)e(p).addClass("sb-status-typing").html(s("Typing"));else{let t=this.agent_online||this.agent_id==v;e(p).removeClass("sb-status-typing").html(s(t?"Online":"Away")),t&&e(p).addClass("sb-status-online")}this.typing_settings.typing=t,N.event("SBTyping",t)}}},showArticles:function(e=-1){let t=y?o.find(".sb-panel-main .sb-panel"):m.find(" > .sb-panel-articles"),i="";t.html("").sbLoading(!0),this.showPanel("articles",C["articles-title"]?C["articles-title"]:"Help Center"),this.getArticles(e,a=>{if(-1==e){let e=[];for(var n=0;n<this.articles_categories.length;n++){let t=this.articles_categories[n],r="";for(var o=0;o<a.length;o++){let i=a[o];e.includes(i.id)||t&&!N.null(i.parent_category)&&!i.parent_category.includes(t.id)||(r+=`<div data-id="${i.id}"><div>${i.title}</div><span>${i.content}</span></div>`,e.push(i.id))}r&&(i+=(t?`<div data-id="${t.id}" class="sb-title">${s(t.title)}</div>`:"")+r)}t.html(`<div class="sb-articles">${i}</div>`)}else a&&t.html(this.getArticleCode(a));t.sbLoading(!1),N.event("SBArticles",{id:e,articles:a})})},getArticles:function(e=-1,t=!1,i=!0){if(!1===this.articles||-1!=e)N.ajax({function:"get-articles",categories:i,articles_language:typeof SB_LANG!=E&&SB_LANG[0],id:e},i=>{-1==e&&(this.articles=i[0],this.articles_categories=i[1].length?i[1]:[""]),t(-1==e?i[0]:i)});else{if(!t)return this.articles;if(i&&!0!==i&&"true"!=i){let e=[];for(var s=0;s<this.articles.length;s++)("categories"in this.articles[s]&&this.articles[s].categories.includes(i)||"parent_category"in this.articles[s]&&i==this.articles[s].parent_category)&&e.push(this.articles[s]);t(e)}else t(this.articles)}},searchArticles:function(t,i,a){t&&(e(i).sbLoading(!0),N.ajax({function:"search-articles",articles_language:typeof SB_LANG!=E&&SB_LANG[0],search:t},t=>{let n="";if(0==t.length)n+=`<p class="sb-no-results">${s("No articles found.")}</p>`;else for(var o=0;o<t.length;o++)n+=`<div data-id="${t[o].id}"><div>${t[o].title}</div><span>${t[o].content}</span></div>`;e(a).html(n),e(i).sbLoading(!1)}))},setArticleRating:function(e,t,i=!1){N.ajax({function:"article-ratings",article_id:e,rating:t},e=>{i&&i(e)})},articleRatingOnClick:function(t){let i=e(t).closest(".sb-article");if(!i[0].hasAttribute("data-user-rating")){e(t).parent().sbLoading();let s="positive"==e(t).attr("data-rating")?1:-1,a=e(t).closest(".sb-article").attr("data-id");q.setArticleRating(a,s,()=>{N.storage("article-rating-"+a,s),i.attr("data-user-rating",s),e(t).parent().sbLoading(!1)})}},getArticleCode:function(e){let t=N.storage("article-rating-"+e.id),i="";if(this.articles_categories&&!N.null(e.categories))for(var a=0;a<this.articles_categories.length;a++){let t=this.articles_categories[a].id;(e.categories.includes(t)||e.parent_category==t)&&(i+=`<span data-id="${t}">${s(this.articles_categories[a].title)}</span>`)}return`<div data-id="${e.id}"${t?` data-user-rating="${t}"`:""} class="sb-article"><div class="sb-title">${e.title}<div class="sb-close sb-icon-close"></div></div><div class="sb-content">${e.content.replace(/(?:\r\n|\r|\n)/g,"<br>")}</div>${N.null(e.link)?"":`<a href="${e.link}" target="_blank" class="sb-btn-text"><i class="sb-icon-plane"></i>${s("Read more")}</a>`}${i?`<div class="sb-article-category-links">${i}</div>`:""}<div class="sb-rating"><span>${s("Rate and review")}</span><div><i data-rating="positive" class="sb-submit sb-icon-like"><span>${s("Helpful")}</span></i><i data-rating="negative" class="sb-submit sb-icon-dislike"><span>${s("Not helpful")}</span></i></div></div></div>`},initArticlesPage:function(){let i,a,n="",o="",r={},l={};(R=e("body").find("#sb-articles")).length||(R=e("body")),R.sbLoading(!0),this.getArticles(-1,()=>{for(i=0;i<this.articles.length;i++){let t=this.articles[i];if(n+=`<div data-id="${t.id}"><div>${t.title}</div><span>${t.content}</span></div>`,!N.null(t.parent_category)&&(t.parent_category in r||(r[t.parent_category]=[]),!N.null(t.categories)))for(var e=0;e<t.categories.length;e++)r[t.parent_category].includes(t.categories[e])||r[t.parent_category].push(t.categories[e])}for(i=0;i<this.articles_categories.length;i++)l[this.articles_categories[i].id]=this.articles_categories[i].title;for(var t in r){o+=`<div class="sb-parent-category"><span data-id="${t}">${s(l[t])}</span><div class="sb-ul">`;for(var i=0;i<r[t].length;i++)o+=`<span data-id="${r[t][i]}">${s(l[r[t][i]])}</span>`;o+="</div></div>"}R.html(`<div class="sb-articles-page${C.rtl?" sb-rtl":""}"><div class="sb-panel-main sb-articles">${n}</div><div class="sb-panel-side"><div class="sb-title">${C["articles-title"]?C["articles-title"]:"Help Center"}</div><div class="sb-input sb-input-btn"><input placeholder="${s("Search for articles...")}" autocomplete="off"><div class="sb-submit-articles sb-icon-arrow-right"></div></div><div class="sb-title">${s("Categories")}</div><div class="sb-article-categories"><div><span data-id="true" class="sb-active">${s("All articles")}</span></div>${o}</div></div></div>`),R.sbLoading(!1),a=R.find(".sb-panel-main"),N.getURL("article")&&R.find(`.sb-articles > [data-id="${N.getURL("article")}"]`).click()}),R.on("click",".sb-articles > [data-id]",function(){i=a.html(),a.sbLoading(!0),q.getArticles(e(this).attr("data-id"),e=>{a.removeClass("sb-articles").html(q.getArticleCode(e)),a.sbLoading(!1)})}),R.on("click",".sb-article [data-rating]",function(){q.articleRatingOnClick(this)}),R.on("click",".sb-article .sb-title .sb-close",function(){R.find(".sb-panel-main").addClass("sb-articles").html(i)}),R.on("click",".sb-submit-articles",function(){let t=e(this).parent().find("input").val();t?(i=a.html(),a.html(""),q.searchArticles(t,this,a)):a.html(i),a.addClass("sb-articles")}),R.on("click",".sb-article-categories [data-id]",function(){if(t(a))return;let n="";i=a.html(),R.find(".sb-article-categories [data-id]").sbActivate(!1),e(this).sbActivate(!0),q.getArticles(-1,e=>{for(var t=0;t<e.length;t++)n+=`<div data-id="${e[t].id}"><div>${e[t].title}</div><span>${e[t].content}</span></div>`;a.addClass("sb-articles").html(n||`<p class="sb-no-results">${s("No articles found.")}</p>`),a.sbLoading(!1)},e(this).attr("data-id"))})},categoryEmoji:function(e){let t=this.emoji_options.list;if("all"==e)this.emoji_options.list_now=t;else{this.emoji_options.list_now=[];for(var i=0;i<t.length;i++)t[i].category.startsWith(e)&&this.emoji_options.list_now.push(t[i])}this.emoji_options.range=0,this.populateEmoji(0),this.populateEmojiBar()},mouseWheelEmoji:function(e){let t=this.emoji_options.range;(function(e){let t=e.originalEvent.wheelDelta;return typeof t==E&&(t=e.originalEvent.deltaY),typeof t==E&&(t=-1*e.originalEvent.detail),t})(e)>0||$&&typeof e.originalEvent.changedTouches!==E&&this.emoji_options.touch<e.originalEvent.changedTouches[0].clientY?t-=t<1?0:1:t+=t>this.emoji_options.range_limit?0:1,f.find(".sb-emoji-bar > div").sbActivate(!1).eq(t).sbActivate(),this.emoji_options.range=t,this.populateEmoji(t),e.preventDefault()},insertEmoji:function(t){t.indexOf(".svg")>0&&(t=e.parseHTML(t)[0].alt),this.insertText(t),f.sbTogglePopup()},showEmoji:function(e){f.sbTogglePopup(e)&&(_||f.css({left:u.offset().left+(y?68:20),top:u.offset().top-window.scrollY-(y?u.height()-330:304)}),""==f.find(".sb-emoji-list > ul").html()&&jQuery.ajax({method:"POST",url:SB_AJAX_URL,data:{function:"emoji"}}).done(e=>{this.emoji_options.list=JSON.parse(e),this.emoji_options.list_now=this.emoji_options.list,this.populateEmoji(0),this.populateEmojiBar()}),N.deselectAll())},populateEmoji:function(e){let t="",i=$?42:48,s=e*i+i,a=this.emoji_options.list_now;s>a.length&&(s=a.length),this.emoji_options.range_limit=a.length/i-1,this.emoji_options.range=e;for(var n=e*i;n<s;n++)t+=`<li>${a[n].char}</li>`;f.find(".sb-emoji-list").html(`<ul>${t}</ul>`)},populateEmojiBar:function(){let e='<div class="sb-active"></div>',t=$?42:49;for(var i=0;i<this.emoji_options.list_now.length/t-1;i++)e+="<div></div>";this.emoji_options.range=0,f.find(".sb-emoji-bar").html(e)},clickEmojiBar:function(t){let i=e(t).index();this.populateEmoji(i),this.emoji_options.range=i,f.find(".sb-emoji-bar > div").sbActivate(!1).eq(i).sbActivate()},searchEmoji:function(e){N.search(e,()=>{if(e.length>1){let i=this.emoji_options.list,s=[];for(var t=0;t<i.length;t++)(i[t].category.toLowerCase().includes(e)||i[t].name.toLowerCase().includes(e))&&s.push(i[t]);this.emoji_options.list_now=s}else this.emoji_options.list_now=this.emoji_options.list;this.emoji_options.range=0,this.populateEmoji(0),this.populateEmojiBar()})},textareaChange:function(t){let i=e(t).val();_&&SBAdmin.conversations.savedReplies(t,i),i?(this.typing(_&&!L.active?SB_ACTIVE_AGENT.id:a().id,"set"),this.activateBar()):this.activateBar(!1)},insertText:function(t){let i=e(h.get(0)),s=0;if(this.dashboard)return!1;if("selectionStart"in i.get(0))s=i.get(0).selectionStart;else if("selection"in document){i.focus();let e=document.selection.createRange();var a=document.selection.createRange().text.length;e.moveStart("character",-i.value.length),s=e.text.length-a}i.val(i.val().substr(0,s)+t+i.val().substr(s)),i.focus(),i.manualExpandTextarea(),this.activateBar()},enabledAutoExpand:function(){h.length&&h.autoExpandTextarea()},privacy:function(){N.ajax({function:"get-block-setting",value:"privacy"},e=>{m.append(`<div class="sb-privacy sb-init-form" data-decline="${e.decline}"><div class="sb-title">${e.title}</div><div class="sb-text">${e.message}</div>`+(e.link?`<a target="_blank" href="${e.link}">${e["link-name"]}</a>`:"")+`<div class="sb-buttons"><a class="sb-btn sb-approve">${e["btn-approve"]}</a><a class="sb-btn sb-decline">${e["btn-decline"]}</a></div></div>`),this.finalizeInit(),N.event("SBPrivacy")}),this.dashboard||this.showDashboard(),this.dashboard=!0,o.addClass("sb-init-form-active")},popup:function(e=!1,t=!1){if(e){let e=o.find(".sb-popup-message"),t=e.attr("data-id");return i("popup"+(N.null(t)?"":t),!0),void e.remove()}setTimeout(()=>{this.chat_open||(0==t&&(t=C.popup),o.find(".sb-popup-message").remove(),o.append(`<div data-id="${"id"in t?t.id:""}" class="sb-popup-message">`+("image"in t&&t.image?`<img src="${t.image}" />`:"")+("title"in t&&t.title?`<div class="sb-top">${t.title}</div>`:"")+`<div class="sb-text">${t.message}</div><div class="sb-icon-close"></div></div>`),N.event("SBPopup",t))},1e3)},followUp:function(){this.followUpCheck()&&(w&&clearTimeout(w),w=setTimeout(()=>{if(this.followUpCheck()){let e=C.follow;this.sendMessage(v,`[email id="sb-follow-up-form" title="${e.title}" message="${e.message}" placeholder="${e.placeholder}" name="${e.name}" last-name="${e["last-name"]}" phone="${e.phone}" phone-required="${e["phone-required"]}" success="${e.success}"]`),this.scrollBottom(),N.storageTime("email"),N.event("SBFollowUp")}},N.null(C.follow.delay)?C["office-hours"]||x?15e3:F.dialogflow.active()?8e3:5e3:parseInt(C.follow.delay)))},followUpCheck:function(){return!_&&this.conversation&&C.follow.active&&a()&&""==a().get("email")&&N.storageTime("email",24)&&(C["office-hours"]||!C.follow["disable-office-hours"])},welcome:function(){"open"==C["welcome-trigger"]&&!this.chat_open||!C["office-hours"]&&C["welcome-disable-office-hours"]||!C.welcome||i("welcome")||!a()||N.ajax({function:"get-block-setting",value:"welcome"},e=>{setTimeout(()=>{C["dialogflow-welcome"]?!1===this.conversation?this.newConversation(3,-1,"",[],null,null,function(){F.dialogflow.welcome()}):F.dialogflow.welcome():this.sendMessage(v,e.message,[],!1,!1,3),e.open&&this.start(),e.sound&&this.audio.play(),this.skip=!0,N.event("SBWelcomeMessage")},parseInt(y?0:C["welcome-delay"])),i("welcome",!0)})},subscribe:function(){C.subscribe&&!i("subscribe")&&a()&&N.null(a().get("email"))&&a()&&setTimeout(()=>{N.ajax({function:"get-block-setting",value:"subscribe"},e=>{this.sendMessage(v,e.message,[],!1,{event:"open-chat"},3),e.sound&&this.audio&&this.audio.play(),this.skip=!0,i("subscribe",!0)})},parseInt(C["subscribe-delay"]))},offlineMessage:function(){if(!_&&!this.offline_message_set&&C.timetable&&(!C["office-hours"]||!x&&!C["timetable-disable-agents"])&&N.storageTime("timetable",1)){let e=C["timetable-message"];switch(C["timetable-type"]){case"header":e[0]&&g.find(".sb-title").html(e[0]),g.find(".sb-text").html(e[1]),this.offline_message_set=!0;break;case"info":d.prepend(`<div class="sb-notify-message sb-rich-cnt"><div class="sb-cnt"><div class="sb-message">${e[0]?`<b>${e[0]}</b> `:""}${e[1]}</div></div></div>`),o.addClass("sb-notify-active"),this.offline_message_set=!0;break;default:setTimeout(()=>{this.conversation&&(this.sendMessage(v,C["timetable-hide"]?`${e[0]?`*${e[0]}*\n`:""}${e[1]}`:"[timetable]"),this.scrollBottom(),this.offline_message_set=!0,N.storageTime("timetable"))},5e3)}}},slackMessage:function(e,t,i,s,n=[]){if(!this.conversation||!s&&!n.length)return!1;let o=this.conversation.id;N.ajax({function:"send-slack-message",user_id:e,full_name:t,profile_image:i,conversation_id:o,message:s,attachments:n,channel:this.slack_channel[0]==a().id?this.slack_channel[1]:-1},e=>{this.slack_channel=[a().id,e[1]],N.event("SBSlackMessageSent",{message:s,conversation_id:o,slack_channel:e[1]})})},deleteMessage:function(e){N.ajax({function:"delete-message",message_id:e},()=>{this.conversation.deleteMessage(e),d.find(`[data-id="${e}"]`).remove(),N.event("SBMessageDeleted",e)})},registration:function(e=!1,t=C["registration-required"]){if(e)return C["registration-required"]&&(!C["registration-offline"]||!x)&&(!C["registration-timetable"]||!C["office-hours"])&&(!1===a()||["visitor","lead"].includes(a().type));m.append(P.generate({},C["registration-link"]?"login":t,"sb-init-form")),this.dashboard||this.showDashboard(),this.dashboard=!0,this.finalizeInit(),o.addClass("sb-init-form-active")},activateBar:function(e=!0){u.find(".sb-bar").sbActivate(e)},addUserAndLogin:function(e=!1){N.ajax({function:"add-user-and-login"},t=>{N.loginCookie(t[1]),a(new U(t[0])),L.start(),L.active||q.automations.run_all(),!1!==e&&e(t)})},isInitDashboard:function(){return C["init-dashboard"]||a()&&a().conversations.length>1},uploadResponse:function(t){if("success"==(t=JSON.parse(t))[0])if("extension_error"==t[1]){let e="The file you are trying to upload has an extension that is not allowed.";_?SBAdmin.dialog(e,"info"):alert(e)}else if(e(l).hasClass("sb-input-image"))e(l).find(".image").attr("data-value","").css("background-image",""),setTimeout(()=>{e(l).find(".image").attr("data-value",t[1]).css("background-image",`url("${t[1]}?v=${N.random()}")`).append('<i class="sb-icon-close"></i>'),l=!1},500);else{let e=t[1].substr(t[1].lastIndexOf("/")+1);u.find(".sb-attachments").append(`<div data-name="${e}" data-value="${t[1]}">${e}<i class="sb-icon-close"></i></div>`),q.activateBar()}else N.error(t[1],"sb-upload-files.change");this.busy(!1)},automations:{history:[],busy:[],scroll_position_intervals:{},run_all:function(){let t=C.automations;for(var i=0;i<t.length;i++){let o=t[i],r=o.conditions,l=0==r.length,c=!1,d=!1,u=!1;for(var s=0;s<r.length;s++){let t=r[s][1];switch(l=!1,r[s][0]){case"browsing_time":l=!0,c=t;break;case"scroll_position":l=!0,d=t;break;case"include_urls":case"exclude_urls":case"referring":let i="referring"==r[s][0]?document.referrer:window.location.href,o=r[s][2].split(","),h="exclude_urls"!=r[s][0];h||(l=!0),i=i.replace("https://","").replace("http://","").replace("www.","");for(var n=0;n<o.length;n++)if(o[n]=e.trim(o[n].replace("https://","").replace("http://","").replace("www.","")),"contains"==t&&-1!=i.indexOf(o[n])||"does-not-contain"==t&&-1==i.indexOf(o[n])||"is-exactly"==t&&o[n]==i||"is-not"==t&&o[n]!=i){l=h;break}break;case"custom_variable":let g=t.split("=");g[0]in window&&window[g[0]]==g[1]&&(l=!0);break;case"returning_visitor":case"user_type":case"cities":case"languages":case"countries":l=a(),u=!0;break;case"user_phone":l=a()&&!N.null(a().getExtra("phone"));break;case"user_email":l=a()&&!N.null(a().get("email"));break;default:l=!0}if(!l)break}["messages","emails","sms"].includes(o.type)&&!a()&&(l=!1),l&&(u?o.id in this.busy||(N.ajax({function:"automations-validate",automation:o},e=>{!1!==e&&this.run_all_final(o,d,c),delete this.busy[o.id]}),this.busy[o.id]=!0):this.run_all_final(o,d,c))}},run_all_final:function(t,i,s){i?this.scroll_position_intervals[t.id]=setInterval(()=>{e(window).scrollTop()>parseInt(i)&&(s?setTimeout(()=>{this.run(t)},1e3*parseInt(s)):this.run(t),clearInterval(this.scroll_position_intervals[t.id]))},1e3):s?setTimeout(()=>{this.run(t)},1e3*parseInt(s)):this.run(t)},run:function(t){if(!this.history.includes(t.id))switch(t.type){case"messages":case"emails":case"sms":if(!(t.id in this.busy)){if("messages"==t.type&&q.chat_open){let e=!!q.conversation&&q.conversation.getLastUserMessage(!1,"no-bot");if(e&&Date.now()-6e5<N.unix(e.get("creation_time")))return}N.ajax({function:"automations-run",automation:t},e=>{!1!==e&&(this.history.push(t.id),"messages"!=t.type||L.active||q.updateConversations()),delete this.busy[t.id]}),this.busy[t.id]=!0}break;case"popups":i("popup"+t.id)||setTimeout(()=>{if(q.chat_open){if(t.fallback){let e=!!q.conversation&&q.conversation.getLastUserMessage(!1,"no-bot");(!e||Date.now()-6e5>N.unix(e.get("creation_time")))&&(q.sendMessage(v,(N.null(t.title)?"":`*${t.title}*\n`)+t.message,[],!1,!1,0),i("popup"+t.id,!0),this.history.push(t.id))}}else q.popup(!1,{id:t.id,image:t.profile_image,title:t.title,message:t.message}),this.history.push(t.id)},1e3);break;case"design":t.background&&g.css("background-image",`url("${t.background}")`),t.brand&&g.find(".sb-brand img").attr("src",t.brand),t.title&&g.find(".sb-title").html(t.title),t.message&&g.find(".sb-text").html(t.message),t.icon&&o.find(".sb-chat-btn .sb-icon").attr("src",t.icon),(t.color_1||t.color_2||t.color_3)&&N.ajax({function:"chat-css",color_1:t.color_1,color_2:t.color_2,color_3:t.color_3},t=>{e("head").append(`<style>${t}</style>`)}),this.history.push(t.id)}}},flashNotification:function(){clearInterval(k),k=setInterval(function(){document.title=document.title==A?s("New message..."):A},2e3)}};window.SBChat=q;var P={rich_messsages:{email:"",button:"",video:"",image:"","woocommerce-button":"",chips:'<div class="sb-buttons">[options]</div>',buttons:'<div class="sb-buttons">[options]</div>',select:'<div class="sb-select"><p></p><ul>[options]</ul></div>',list:'<div class="sb-text-list">[values]</div>',"list-image":'<div class="sb-image-list">[values]</div>',table:"<table><tbody>[header][values]</tbody></table>",inputs:'<div class="sb-form">[values]</div>',rating:'<div class="sb-rating"><span>[label]</span><div><i data-rating="positive" class="sb-submit sb-icon-like"><span>[positive]</span></i><i data-rating="negative" class="sb-submit sb-icon-dislike"><span>[negative]</span></i></div></div>',card:'<div class="sb-card">[settings]</div>',share:'<div class="sb-social-buttons">[settings]</div>',slider:'<div class="sb-slider"><div>[items]</div></div><div class="sb-slider-arrow sb-icon-arrow-left[class]"></div><div class="sb-slider-arrow sb-icon-arrow-right sb-active[class]"></div>',"slider-images":'<div class="sb-slider sb-slider-images"><div>[items]</div></div><div class="sb-slider-arrow sb-icon-arrow-left[class]"></div><div class="sb-slider-arrow sb-icon-arrow-right sb-active[class]"></div>',phone:""},cache:{},generate:function(t,i,n=""){let r,l=!0,c="id"in t?t.id:N.random();if(i in this.rich_messsages)r=this.rich_messsages[i];else if(i in this.cache)r=this.cache[i];else{if(!(_||!N.null(C)&&"rich-messages"in C&&C["rich-messages"].includes(i)))return!1;"id"in t||(c=i),r='<div class="sb-rich-loading sb-loading"></div>',N.ajax({function:"get-rich-message",name:i},e=>{e=this.initInputs(e),e=new D({}).render(e),"timetable"==i&&(e=this.timetable(e)),o.find(`.sb-rich-message[id="${c}"]`).html(`<div class="sb-content">${e}</div>`),this.cache[i]=e,q.scrollBottom(q.dashboard)}),l=!1}let d="disabled"in t;if(l){let n,o="";switch(i){case"rating":r=r.replace("[label]",s(N.null(t.label)?"Rate and review":t.label)).replace("[positive]",s(N.null(t["label-positive"])?"Helpful":t["label-positive"])).replace("[negative]",s(N.null(t["label-negative"])?"Not helpful":t["label-negative"]));break;case"email":let l=[],c=a().get("email"),h="#"==a().get("last_name").charAt(0);"true"==t.name&&l.push(["first_name","true"==t["last-name"]?"First name":"Name",h?"":"true"==t["last-name"]?a().get("first_name"):a().name,"text",!0]),"true"==t["last-name"]&&l.push(["last_name","Last name",h?"":a().get("last_name"),"text",!0]);for(u=0;u<l.length;u++)r+=`<div id="${l[u][0]}" data-type="text" class="sb-input sb-input-text"><span class="${""==l[u][2]?"":"sb-active sb-filled"}">${s(l[u][1])}</span><input value="${l[u][2]}" autocomplete="false" type="${l[u][3]}" ${l[u][4]?"required":""}></div>`;if("true"==t.phone){let e=a().getExtra("phone"),i=_?[]:C["phone-codes"],n="";for(u=0;u<i.length;u++)n+=`<option value="+${i[u]}">+${i[u]}</option>`;r+=`<div id="phone" data-type="select-input" class="sb-input sb-input-select-input"><span class="${""==e?"":"sb-active sb-filled"}">${s("Phone")}</span><div><select><option value=""></option>${n}</select></div><input value="${_?"":e}" pattern="[0-9]+" autocomplete="false" type="tel" ${"false"!=t["phone-required"]?"required":""}></div>`}r+=`<div id="email" data-type="email" class="sb-input sb-input-btn"><span class="${""==c?"":"sb-active sb-filled"}">${s(N.null(t.placeholder)?"Email":t.placeholder)}</span><input value="${c}" autocomplete="off" type="email" required><div class="sb-submit sb-icon-arrow-right"></div></div>`;break;case"image":r=`<div class="sb-image"><img src="${t.url}"></div>`;break;case"video":r=`<iframe${"height"in t?` height="${t.height}"`:""} src="${"youtube"==t.type?"//www.youtube.com/embed/":"//player.vimeo.com/video/"}${t.id}" allowfullscreen></iframe>`;break;case"select":n=t.options.split(",");for(u=0;u<n.length;u++)o+=`<li data-value="${N.stringToSlug(n[u])}">${s(n[u])}</li>`;r=r.replace("[options]",o);break;case"chips":case"buttons":n=t.options.split(",");for(u=0;u<n.length;u++)o+=`<div class="sb-btn sb-submit">${s(n[u])}</div>`;r=r.replace("[options]",o);break;case"button":r=`<a href="${t.link.replace(/<i>/g,"_").replace(/<\/i>/g,"_")}"${"target"in t?' target="_blank"':""} class="sb-rich-btn sb-btn${"link"==t.style?"-text":""}">${s(t.name)}</a>`;break;case"list":n=t.values.split(",");let g="list"==i,p=g&&n.length&&n[0].indexOf(":")>0;g&&!p&&(r=r.replace("sb-text-list","sb-text-list sb-text-list-single"));for(u=0;u<n.length;u++)o+=p?`<div><div>${s(n[u].split(":")[0])}</div><div>${s(n[u].split(":")[1])}</div></div>`:`<div>${e.trim(s(n[u]))}</div>`;r=r.replace("[values]",o);break;case"list-image":n=t.values.split(",");for(u=0;u<n.length;u++){let e=n[u].replace("://","///").split(":");o+=`<div><div class="sb-thumb" style="background-image:url('${e[0].replace("///","://")}')"></div><div class="sb-list-title">${e[1]}</div><div>${e[2]}</div></div>`}r=r.replace("[values]",o);break;case"table":n=t.header.split(","),o+="<tr>";for(u=0;u<n.length;u++)o+=`<th>${n[u]}</th>`;o+="</tr>",r=r.replace("[header]",o),o="",n=t.values.split(",");for(u=0;u<n.length;u++){let e=n[u].split(":");o+="<tr>";for(u=0;u<e.length;u++)o+=`<td>${e[u]}</td>`;o+="</tr>"}r=r.replace("[values]",o);break;case"inputs":n=t.values.split(",");for(u=0;u<n.length;u++)d&&""==n[u]||(o+=`<div id="${N.stringToSlug(n[u])}" data-type="text" class="sb-input sb-input-text"><span>${s(n[u])}</span><input autocomplete="false" type="text" required></div>`);o+='<div class="sb-btn sb-submit">'+s("button"in t?t.button:"Send now")+"</div>",r=r.replace("[values]",o);break;case"card":o=`${"image"in t?`<div class="sb-card-img" style="background-image:url('${t.image}')"></div>`:""}<div class="sb-card-header">${t.header}</div>${"extra"in t?`<div class="sb-card-extra">${t.extra}</div>`:""}${"description"in t?`<div class="sb-card-description">${t.description}</div>`:""}${"link"in t?`<a class="sb-card-btn" href="${t.link}"${"target"in t?' target="_blank"':""}>${s(t["link-text"])}</a>`:""}`,r=r.replace("[settings]",o);break;case"share":let f="channels"in t?t.channels.replace(/ /g,"").split(","):["fb","tw","li","wa","pi"],m="";for(u=0;u<f.length;u++){switch(f[u]){case"fb":m="www.facebook.com/sharer.php?u=";break;case"tw":m="twitter.com/intent/tweet?url=";break;case"li":m="www.linkedin.com/sharing/share-offsite/?url=";break;case"wa":m="web.whatsapp.com/send?text=";break;case"pi":m="www.pinterest.com/pin/create/button/?url="}o+=`<div class="sb-${f[u]} sb-icon-social-${f[u]}" data-link="https://${m}${t.link}"></div>`}r=r.replace("[settings]",o);break;case"slider":let v=0;for(u=1;u<16&&"header-"+u in t;u++)o+=`<div>${"image-"+u in t?`<div class="sb-card-img" style="background-image:url('${t["image-"+u]}')"></div>`:""}<div class="sb-card-header">${t["header-"+u]}</div>${"extra-"+u in t?`<div class="sb-card-extra">${t["extra-"+u]}</div>`:""}${"description-"+u in t?`<div class="sb-card-description">${t["description-"+u]}</div>`:""}${"link-"+u in t?`<a class="sb-card-btn" href="${t["link-"+u]}"${"target"in t?' target="_blank"':""}>${s(t["link-text-"+u])}</a>`:""}</div>`,v++;r=r.replace("[items]",o).replace(/\[class\]/g,1==v?" sb-hide":"");break;case"slider-images":if("images"in t){let e=t.images.split(",");for(var u=0;u<e.length;u++)o+=`<div class="sb-card-img" data-value="${e[u]}" style="background-image:url('${e[u]}')"></div>`;r=r.replace(/\[class\]/g,1==e.length?" sb-hide":"")}r=r.replace("[items]",o);break;case"woocommerce-button":t.settings=`checkout:${t.checkout},coupon:${t.coupon}`,r=`<a href="#" data-ids="${t.ids}" class="sb-rich-btn sb-btn">${t.name}</a>`}}return`<div id="${c}" data-type="${i}"${d?'disabled="true"':""}${"settings"in t?` data-settings="${t.settings}"`:""}class="sb-rich-message sb-rich-${i} ${n}">`+("title"in t?`<div class="sb-top">${s(t.title)}</div>`:"")+("message"in t?`<div class="sb-text">${s(t.message)}</div>`:"")+`<div class="sb-content">${r}</div><div data-success="${"success"in t?t.success.replace(/"/g,""):""}" class="sb-info"></div></div>`},submit:function(i,n,r){if(!_&&!t(r)&&!this.is_busy){let t="",c="",d={},u=e(i).find("[data-success]").length?e(i).find("[data-success]").attr("data-success"):"",h=e(i).closest(".sb-rich-message").attr("id"),g=e(i).closest("[data-id]").attr("data-id"),p="",f={"rich-messages":{}},m=0==a()?{profile_image:["",""],first_name:["",""],last_name:["",""],email:["",""],password:["",""],user_type:["",""]}:{profile_image:[a().image,""],first_name:[a().get("first_name"),""],last_name:[a().get("last_name"),""],email:[a().get("email"),""],password:["",""],user_type:["",""]},_={},y=e(r),w="",k=!1!==q.conversation,S={},A={};if(N.null(g))g=-1;else{let e=q.conversation.getMessage(g);p=e.message,"rich-messages"in(f=e.payload())||(f["rich-messages"]={})}switch(e(r).hasClass("sb-btn")||e(r).hasClass("sb-select")||e(r).hasClass("sb-submit")||(y=e(r).closest(".sb-btn,.sb-select")),e(i).find(".sb-info").html("").sbActivate(!1),n){case"email":"first_name"in(_=G.getAll(i))&&(m.user_type=["user",""],"last_name"in _||(m.last_name=["",""])),"phone"in _&&(S={phone:[_.phone[0],"Phone"]}),e.extend(m,_),t="Please fill in all required fields and make sure the email is valid.",u&&(u=s(u).replace("{user_email}",m.email[0])),f["rich-messages"][h]={type:n,result:_},f.event="update-user",d={function:"update-user-and-message",settings:m,settings_extra:S,payload:f},w="email-complete";break;case"registration":if(S=G.getAll(i.find(".sb-form-extra")),e.extend(m,G.getAll(i.find(".sb-form-main"))),A=e.extend({},m),u&&(u=s(u)),C["registration-details"]){u+='[list values="';for(var l in m){let e=m[l][0].replace(/:|,/g,"");e&&("profile_image"==l&&(e=e.substr(e.lastIndexOf("/")+1)),"password"!=l&&"password-check"!=l||(e="********",A[l]="********"),u+=""==m[l][1]?"":`${s(m[l][1].replace(/:|,/g,""))}:${e},`)}for(var l in S)S[l][0]&&(u+=`${s(S[l][1].replace(/:|,/g,""))}:${S[l][0].replace(/:|,/g,"")},`);u=u.slice(0,-1)+'"]'}m.user_type=["user",""],f["rich-messages"][h]={type:n,result:{user:A,extra:S}},f.event="update-user",d={function:a()?"update-user-and-message":"add-user-and-login",settings:m,settings_extra:S,payload:f},t=G.getRegistrationErrorMessage(i),w=JSON.stringify(m);break;case"rating":let o=e(r).attr("data-rating");u=`${s("Your rating is")} *${s(o)}*. ${s(""==u?"Thank you for your feedback!":u)}`,_={conversation_id:q.conversation.id,agent_id:q.agent_id,user_id:a().id,message:i.find("textarea").val(),rating:"positive"==o?1:-1},f["rich-messages"][h]={type:n,result:_},d={function:"set-rating",payload:f,settings:_},w=o;break;case"chips":case"select":case"buttons":_=N.escape(e(r).html()),u=""==u?u:s(u)+` *${_}*`,f["rich-messages"][h]={type:n,result:_},d={function:"update-message",payload:f},w=_,"chips"==n&&(q.sendMessage(a().id,_,[],!1,{id:h,event:"chips-click",result:_},"sb-human-takeover"==h&&0==y.index()&&2),"sb-human-takeover"==h&&0==e(r).index()&&F.dialogflow.humanTakeover(),e(r).closest(".sb-content").remove());break;case"inputs":if(_=G.getAll(i),t="All fields are required.",u){u=s(u)+' [list values="';for(var l in _)u+=`${s(_[l][1].replace(/:|,/g,""))}:${_[l][0].replace(/:|,/g,"")},`;u=u.slice(0,-1)+'"]'}f["rich-messages"][h]={type:n,result:_},d={function:"update-message",payload:f},w=JSON.stringify(_)}if(c=p.substr(p.indexOf("["+n)),c=c.substr(0,c.indexOf("]")+1),t&&G.errors(i))return G.showErrorMessage(i,t),y.sbLoading(!1),(q.dashboard||k&&q.conversation.getLastMessage().id==g)&&q.scrollBottom(),!1;if(!u&&"registration"!=n){let e=this.shortcode(c),t="title"in e[1]?`title="${e[1].title}"`:"",i="message"in e[1]?`message="${e[1].message}"`:"",s="";if(["inputs","email"].includes(n)){for(var l in _)s+=_[l][0]+",";s=`values="${s.slice(0,-1)}"`}else s=`options="${_}"`;u=`[${"email"==n?"inputs":n} ${t} ${i} ${s} disabled="true"]`}-1!=g&&e.extend(d,{message_id:g,message:p?p.replace(c,u):u,payload:f}),N.ajax(d,t=>{if(0==t||N.errorValidation(t))G.showErrorMessage(i,G.getRegistrationErrorMessage(t,"response")),q.dashboard&&q.scrollBottom(),y.sbLoading(!1);else{switch(n){case"email":for(var s in m)a().set(s,m[s][0]);for(var s in S)a().setExtra(s,S[s][0]);N.loginCookie(t[1]),"sb-subscribe-form"==h&&N.ajax({function:"subscribe-email",email:a().get("email")}),q.automations.run_all(),N.event("SBNewEmailAddress",{id:h,name:a().name,email:a().get("email")});break;case"registration":if(N.loginCookie(t[1]),0==a()){a(new U(t[0]));for(var s in S)a().setExtra(s,S[s][0]);L.start(),q.initChat(),C["init-dashboard"]&&o.find(".sb-departments-list").length||!u||q.sendMessage(v,u,[],!1,!1,3)}else{for(var s in m)a().set(s,m[s][0]);for(var s in S)a().setExtra(s,S[s][0]);q.automations.run_all()}q.dashboard&&(o.removeClass("sb-init-form-active"),e(i).remove(),q.isInitDashboard()||q.hideDashboard()),delete this.cache.registration,setTimeout(()=>{N.event("SBRegistrationForm",{id:h,user:m,extra:f["rich-messages"][h].result.extra})},5e3)}-1==g?e(r).closest(".sb-rich-message").html(u):"type"in f&&"close-message"==f.type||b||q.setConversationStatus(2),["email","registration","login","chips","rating"].includes(n)||F.dialogflow.message(`${h}|${n}|${w}`),!C["slack-active"]||b&&!F.dialogflow.humanTakeoverActive()||q.slackMessage(a().id,a().name,a().image,u),L.active&&q.update(),"registration"!=n&&"email"!=n&&N.event("SBRichMessageSubmit",{result:t,data:f["rich-messages"][h],id:h})}})}},shortcode:function(t){if(t.indexOf(" ")<0)return[t.slice(1,-1),{}];let i={},s=t.substr(1,t.indexOf(" ")-1),a=(t=t.slice(1,-1).substr(s.length+1)).split('" ');for(var n=0;n<a.length;n++)if(a[n].includes("=")){let t=[a[n].substr(0,a[n].indexOf("=")),a[n].substr(a[n].indexOf("=")+2)];i[e.trim(t[0])]=t[1].replace(/"/g,"")}return[s,i]},initInputs:function(t){return(t=e(e.parseHTML("<div>"+t+"</div>"))).find(".sb-input input").each(function(){e(this).val()&&e(this).siblings().addClass("sb-active sb-filled")}),t.html()},timetable:function(t){let i=e(e.parseHTML(`<div>${t}</div>`)),a=i.find("[data-offset]").attr("data-offset");return a=N.null(a)?0:parseInt(a),i.find("[data-time]").each(function(){let n=e(this).attr("data-time").split("|");t="";for(var o=0;o<n.length;o++){if("closed"==n[o]){t+=s("Closed");break}if(n[o]){let e=n[o].split(":"),i=N.convertUTCDateToLocalDate(`01/01/2000 ${e[0]}:${e[1]}`,a);t+=i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})+(0==o||2==o?`<span>${s("to")}</span>`:1==o&&n[o+1]?"<br />":"")}}i.find(" > div > span").html(`<i class="sb-icon-clock"></i> ${s("Time zone")} ${Intl.DateTimeFormat().resolvedOptions().timeZone}`),e(this).html(t)}),i.html()},sliderChange:function(e,t="left"){let i=d.find(`#${e}`);if(i.length&&!i.hasClass("sb-moving")){let e=i.find(".sb-slider > div > div"),s=e.eq(0),a=Math.ceil(s.closest(".sb-slider").width()),n="right"==t?-1:1,o=parseFloat(parseFloat(parseFloat(s.css("margin-left"))+a*n).toFixed(2))+-.5*n,r=a*(e.length-1)*-1;o<1&&o>=r&&(s.css("margin-left",o+"px"),i.addClass("sb-moving"),setTimeout(()=>{i.removeClass("sb-moving")},1200)),i.find(".sb-icon-arrow-right").sbActivate(!(r>o-15&&r<o+15)),i.find(".sb-icon-arrow-left").sbActivate(o<-10)}}},G={getAll:function(t){let i={};return e(t).find(".sb-input[id]").each((t,s)=>{i[e(s).attr("id")]=this.get(s)}),i},get:function(t){let i=(t=e(t)).data("type"),a=s(N.escape(t.find(" > span").html()));switch(i){case"image":let e=t.find(".image").attr("data-value");return[N.null(e)?"":e,a];case"select":return[N.escape(t.find("select").val()),a];case"select-input":return[N.escape(t.find("select").val()+t.find("input").val()),a];default:let s=t.find("input");return[N.escape(s.length?s.val():t.find("[data-value]").attr("data-value")),a]}},set:function(t,i){if((t=e(t)).length){switch(t.data("type")){case"image":""==i?t.find(".image").removeAttr("data-value").removeAttr("style"):t.find(".image").attr("data-value",i).css("background-image",`url("${i}")`);break;case"select":t.find("select").val(i);break;default:t.find("input,textarea").val(i)}return!0}return!1},clear:function(t){e(t).find(".sb-input,.sb-input-setting").each((t,i)=>{this.set(i,""),e(i).find("input, select, textarea").removeClass("sb-error")}),this.set(e(t).find("#user_type"),"user")},errors:function(t){let i=!1,s=e(t).find("input, select, textarea").removeClass("sb-error");return s.each(function(t){let a=e(this).val(),n=e(this).attr("type"),o=e(this).prop("required");(o&&""==a||(o||a)&&("password"==n&&(a.length<8||s.length>t+1&&"password"==s.eq(t+1).attr("type")&&s.eq(t+1).val()!=a)||"email"==n&&(a.indexOf("@")<0||a.indexOf(".")<0||/;|:|\/|\\|,|#|"|!|=|\+|\*|{|}|[|]|£|\$|€|~|'|>|<|\^|&/.test(a))||"tel"==n&&a&&(""==e(this).parent().find("select").val()||isNaN(a)||a.includes("+")||a.length<5)))&&(i=!0,e(this).addClass("sb-error"))}),(s=e(t).find("[data-required]").removeClass("sb-error")).each(function(){N.null(e(this).attr("data-value"))&&(e(this).addClass("sb-error"),i=!0)}),i},showErrorMessage:function(t,i){e(t).find(".sb-info").html(s(i)).sbActivate(),clearTimeout(w),w=setTimeout(function(){e(t).find(".sb-info").sbActivate(!1)},7e3)},showSuccessMessage:function(t,i){e(t).find(".sb-info").remove(),e(t).addClass("sb-success").find(".sb-content").html(`<div class="sb-text">${i}</div>`)},getRegistrationErrorMessage(t,i="validation"){if("response"==i)return N.errorValidation(t,"duplicate-email")?"This email is already in use. Please use another email.":N.errorValidation(t,"duplicate-phone")?"This phone number is already in use. Please use another number.":"Error. Please check your information and try again.";let s=e(t).find("#last_name").length?"First name, last name":"Name",a=e(t).find("#phone[required]").length?", phone number":"",n=e(t).find("#email").length?", email":"",o=e(t).find("#password").length?", and a password (8 character minimum)":"";return`${s}${n}${a}${o} ${n+a+o==""?"is":"are"} required.`}};window.SBForm=G;var F={login:function(){return this.is("wp")&&typeof SB_WP_ACTIVE_USER!=E&&"wp"==C["wp-users-system"]?[[SB_WP_ACTIVE_USER,typeof SB_WP_AVATAR!=E?SB_WP_AVATAR:""],"wp"]:typeof SB_PERFEX_ACTIVE_USER!=E?[[SB_PERFEX_ACTIVE_USER,SB_PERFEX_CONTACT_ID],"perfex"]:typeof SB_WHMCS_ACTIVE_USER!=E?[SB_WHMCS_ACTIVE_USER,"whmcs"]:typeof SB_AECOMMERCE_ACTIVE_USER!=E?[SB_AECOMMERCE_ACTIVE_USER,"aecommerce"]:typeof SB_DEFAULT_USER!=E&&[SB_DEFAULT_USER,"default"]},is:function(e){return _?SBAdmin.apps.is(e):"wordpress"==e||"wp"==e?C.wp:e in C&&C[e]},wordpress:{ajax:function(t,i,s){e.ajax({method:"POST",url:SB_WP_AJAX_URL,data:e.extend({action:"sb_wp_ajax",type:t},i)}).done(e=>{!1!==s&&s(e)})}},woocommerce:{updateCart:function(e,t,i=!1){F.wordpress.ajax(e,{product_id:t},i)},waitingList:function(e="request",t=!1){typeof SB_WP_WAITING_LIST!==E&&("request"!=e||SB_WP_WAITING_LIST&&N.storageTime("waiting-list-"+SB_WP_PAGE_ID,24))&&a()&&N.ajax({function:"woocommerce-waiting-list",product_id:!1===t?SB_WP_PAGE_ID:t,conversation_id:q.conversation.id,action:e,token:this.token},t=>{t&&(N.storageTime("waiting-list-"+SB_WP_PAGE_ID),"request"!=e||q.chat_open&&!q.dashboard||q.updateConversations())})}},dialogflow:{token:i("dialogflow-token"),typing_enabled:!1,message:function(e="",t=[],s=!1){if(this.active()){let n=F.dialogflow.humanTakeoverActive();n&&!this.typing_enabled||(w=setTimeout(()=>{q.typing(-1,"start"),setTimeout(()=>{q.typing(-1,"stop")},1e4)},1e3)),setTimeout(()=>{q.conversation&&N.ajax({function:"dialogflow-message",conversation_id:q.conversation.id,message:e,attachments:t,token:this.token,dialogflow_language:i("dialogflow-language")?i("dialogflow-language"):SB_LANG},t=>{if(!1!==t){if("human_takeover"in t)return q.offlineMessage(),q.followUp(),this.active(!1);if("language_detection"in t&&!i("dialogflow-language")&&i("dialogflow-language",[t.language_detection]),!N.errorValidation(t)){let o="queryResult"in t.response&&t.response.queryResult,r=o&&("input.unknown"==o.action||"match"in o&&"NO_MATCH"==o.match.matchType),l="messages"in t&&Array.isArray(t.messages)?t.messages:[];if(q.typing(-1,"stop"),clearTimeout(w),this.token!=t.token&&(this.token=t.token,i("dialogflow-token",t.token)),r?n&&(this.typing_enabled=!1):this.typing_enabled=!0,o){if("action"in o){let e=o.action;"end"==e&&this.active(!1),N.event("SBBotAction",e)}for(s=0;s<l.length;s++)if("payload"in l[s]){let e=["human-takeover","redirect","woocommerce-update-cart","woocommerce-checkout","open-article","transcript","department","agent","send-email","disable-bot","rich-message"],t=l[s].payload;if(N.null(t)&&(t=[]),e[0]in t&&!0===t[e[0]]&&this.humanTakeover(),e[1]in t&&setTimeout(function(){"new-window"in t&&t["new-window"]?window.open(t[e[1]]):document.location=t[e[1]]},500),e[2]in t){let i=t[e[2]];F.woocommerce.updateCart(i[0],i[1],e=>{e&&N.event("SBWoocommerceCartUpdated",{action:i[0],product:i[1]})})}if(e[3]in t&&!0===t[e[3]]&&F.wordpress.ajax("url",{url_name:"checkout"},e=>{setTimeout(()=>document.location=e,500)}),e[4]in t&&q.showArticles(t[e[4]]),e[5]in t&&t[e[5]]&&N.ajax({function:"transcript",conversation_id:q.conversation.id,type:"txt"},i=>{"email"==t[e[5]]&&a().get("email")?q.sendEmail("message"in t?t.message:"",[[i,i]],!0):window.open(i)}),e[6]in t&&N.ajax({function:"update-conversation-department",conversation_id:q.conversation.id,department:t[e[6]],message:q.conversation.getLastUserMessage().message}),e[7]in t&&N.ajax({function:"update-conversation-agent",conversation_id:q.conversation.id,agent_id:t[e[7]],message:q.conversation.getLastUserMessage().message}),e[8]in t){let i=t[e[8]];q.sendEmail(i.message,i.attachments,"active_user"==i.recipient)}e[9]in t&&(this.active(!1),N.cookie("sb-dialogflow-disabled",!0,300,"set",!0)),e[10]in t&&q.sendMessage(v,t[e[10]]),N.event("SBBotPayload",t)}if("diagnosticInfo"in o){let e=o.diagnosticInfo;"end_conversation"in e&&e.end_conversation&&this.active(!1)}}if(C["slack-active"]&&l&&(!b||n))for(var s=0;s<l.length;s++)q.slackMessage(a().id,C["bot-name"],C["bot-image"],l[s].message,l[s].attachments);N.event("SBBotMessage",{response:t,message:e})}}})},!1!==s?s:0==C["bot-delay"]?2e3:parseInt(C["bot-delay"]))}},active:function(e=!0){let t="human-takeover-"+q.conversation.id;return!1===e?(N.storageTime(t),!1):("activate"==e&&(N.cookie("sb-dialogflow-disabled",0,0,"delete"),N.storage(t,"")),C["dialogflow-active"]&&!_&&!N.cookie("sb-dialogflow-disabled")&&(N.storageTime(t,240)||!q.agent_online)&&(!C["bot-office-hours"]||!C["office-hours"]))},welcome:function(){C["dialogflow-welcome"]&&N.ajax({function:"dialogflow-message",message:"",conversation_id:q.conversation.id,token:this.token,event:"Welcome",dialogflow_language:i("dialogflow-language")?i("dialogflow-language"):SB_LANG})},humanTakeover:function(){N.ajax({function:"dialogflow-human-takeover",conversation_id:q.conversation.id},()=>{q.offlineMessage(),q.followUp(),this.active(!1),C["queue-human-takeover"]&&(C.queue=!0,q.queue(q.conversation.id))})},humanTakeoverActive:function(){return!N.storageTime("human-takeover-"+(q.conversation?q.conversation.id:i("open-conversation")),240)},translate:function(e,t,i){N.ajax({function:"google-translate",strings:e,language_code:t,token:this.token},e=>{this.token=e[1],i("data"in e[0]&&"translations"in e[0].data&&e[0].data.translations)})}},aecommerce:{cart:function(){F.is("aecommerce")&&typeof SB_AECOMMERCE_CART!=E&&typeof SB_AECOMMERCE_ACTIVE_USER!=E&&i("aecommerce")!=JSON.stringify(SB_AECOMMERCE_CART)&&N.ajax({function:"aecommerce-cart",cart:SB_AECOMMERCE_CART},()=>{i("aecommerce",JSON.stringify(SB_AECOMMERCE_CART))})}}};window.SBApps=F,e(document).ready(function(){if((o=e(".sb-admin, .sb-admin-start")).length)return _=!0,void n();let t,i,s=!1;if(typeof SB_INIT_URL!=E)SB_INIT_URL.indexOf(".js")<0&&(SB_INIT_URL+="/js/main.js?v=3.3.8"),t=SB_INIT_URL;else{let e=document.getElementsByTagName("script"),i=["init.js","main.js","min/init.min.js","min/main.min.js"];for(var a=0;a<e.length;a++){let n=e[a].src;if("sbinit"==e[a].id){t=n,s=s||t.includes("init.");break}for(var r=0;r<i.length;r++)if(n.includes("/supportboard/js/"+i[r])){t=n,s=s||t.includes("init.");break}}}let l=N.getURL(!1,t);if("url"in l&&(t=l.url),typeof SB_DISABLED!=E&&SB_DISABLED)return;if(s)return void n();(typeof SB_TICKETS!=E||"mode"in l&&"tickets"==l.mode)&&(y=!0,l.mode="tickets"),"cloud"in l&&(M=l.cloud);let c=(i=t.substr(0,t.lastIndexOf("main.js")>0?t.lastIndexOf("main.js")-4:t.lastIndexOf("main.min.js")-8))+"/include/init.php"+("lang"in l?"?lang="+l.lang:"")+("mode"in l?"&mode="+l.mode:"")+(M?"&cloud="+M:"");N.cors("GET",c.replace(".php&",".php?"),t=>{let s="body";y&&e("#sb-tickets").length&&(s="#sb-tickets"),e(s).append(t),N.loadResource(i+"/css/min/"+(y?"tickets":"main")+".min.css"),y?e.getScript(i+"/apps/tickets/tickets.js?v=3.3.8",()=>{n()}):n()})})}(jQuery);